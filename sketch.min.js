/*
 2016-2017 timescraper.com
 @version 0.5.1
 @author timescraper.com

 @licstart  The following is the entire license notice for the
  JavaScript code in this page.

 Copyright (C) 2016  timescraper.com

  Sketchpad.pro - drawing board sketch pad
  Copyright (C) 2016  timescraper.com

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.

 @licend  The above is the entire license notice
 for the JavaScript code in this page.

 @file Inputs stack

 Date: 2016-08-11T14:00Z
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};var setPallete_HEX=document.querySelector("#pe3"),setPallete_HEX_border=document.querySelector("#pe3"),fill_check=document.querySelector("#fill_check");
Array.prototype.findIndex||(Array.prototype.findIndex=function(a,b){if(null==this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!==typeof a)throw new TypeError("predicate must be a function");for(var c=Object(this),d=c.length>>>0,e,g=0;g<d;g++)if(e=c[g],a.call(b,e,g,c))return g;return-1});
(function(){var a=0,b=["ms","moz","webkit","o"],c,d,e;var g=0;for(c=b.length;g<c&&!window.requestAnimationFrame;++g)window.requestAnimationFrame=window[b[g]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[g]+"CancelAnimationFrame"]||window[b[g]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(f,h){d=(new Date).getTime();e=Math.max(0,16-(d-a));a=d+e;return window.setTimeout(function(){f(d+e)},e)});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(f){clearTimeout(f)})})();"function"!=typeof Object.assign&&function(){Object.assign=function(a){if(void 0===a||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var d=arguments[c];if(void 0!==d&&null!==d)for(var e in d)d.hasOwnProperty(e)&&(b[e]=d[e])}return b}}();
Array.prototype.find||(Array.prototype.find=function(a,b){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!==typeof a)throw new TypeError("predicate must be a function");for(var c=Object(this),d=c.length>>>0,e,g=0;g<d;g++)if(e=c[g],a.call(b,e,g,c))return e});
var NSSketchpad={avaliableTools:[],defaultTool:"pen",watermarkTitle:"sketchpad.pro library is available under AGPL-3 license, visit http://developers.sketchpad.pro for source code. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.",watermarkImageSrc:'data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8" standalone="no"?> <svg    xmlns:dc="http://purl.org/dc/elements/1.1/"    xmlns:cc="http://creativecommons.org/ns#"    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"    xmlns:svg="http://www.w3.org/2000/svg"    xmlns="http://www.w3.org/2000/svg"    xmlns:xlink="http://www.w3.org/1999/xlink"    xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"    xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"    width="128"    height="18"    viewBox="0 0 294.79549 53.369998"    id="svg2"    version="1.1"    inkscape:version="0.91 r13725"    sodipodi:docname="sketchpad-logo-clean.svg">   <sodipodi:namedview      pagecolor="#ffffff"      bordercolor="#666666"      borderopacity="1"      objecttolerance="10"      gridtolerance="10"      guidetolerance="10"      inkscape:pageopacity="0"      inkscape:pageshadow="2"      inkscape:window-width="1296"      inkscape:window-height="719"      id="namedview51"      showgrid="true"      inkscape:zoom="6.416994"      inkscape:cx="72.420486"      inkscape:cy="4.2725026"      inkscape:window-x="99"      inkscape:window-y="0"      inkscape:window-maximized="0"      inkscape:current-layer="layer1">     <inkscape:grid        type="xygrid"        id="grid3441" />   </sodipodi:namedview>   <defs      id="defs4">     <linearGradient        id="rainbow"        inkscape:collect="always">       <stop          offset="0"          style="stop-color:#ff0101;stop-opacity:1"          id="stop6" />       <stop          offset="0.04"          style="stop-color:#ff7901;stop-opacity:1"          id="stop8" />       <stop          offset="0.12"          style="stop-color:#fff001;stop-opacity:1"          id="stop10" />       <stop          offset="0.20"          style="stop-color:#96ff01;stop-opacity:1"          id="stop12" />       <stop          offset="0.27"          style="stop-color:#1fff01;stop-opacity:1"          id="stop14" />       <stop          offset="0.34"          style="stop-color:#01ff5b;stop-opacity:1"          id="stop16" />       <stop          offset="0.41"          style="stop-color:#01ffd2;stop-opacity:1"          id="stop18" />       <stop          offset="0.51"          style="stop-color:#01b4ff;stop-opacity:1"          id="stop20" />       <stop          offset="0.56"          style="stop-color:#013dff;stop-opacity:1"          id="stop22" />       <stop          offset="0.67"          style="stop-color:#3d01ff;stop-opacity:1"          id="stop24" />       <stop          offset="0.78"          style="stop-color:#b401ff;stop-opacity:1"          id="stop26" />       <stop          offset="0.87"          style="stop-color:#ff01d2;stop-opacity:1"          id="stop28" />       <stop          offset="0.95"          style="stop-color:#ff015b;stop-opacity:1"          id="stop30" />       <stop          offset="1"          style="stop-color:#ff0101;stop-opacity:1"          id="stop32" />     </linearGradient>     <linearGradient        xlink:href="#rainbow"        id="linearGradientRainbow"        gradientUnits="userSpaceOnUse"        x1="45"        y1="143"        x2="413"        y2="143"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3379"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3381"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3383"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3385"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3387"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3389"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3391"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3393"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3395"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3397"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3399"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />     <linearGradient        inkscape:collect="always"        xlink:href="#rainbow"        id="linearGradient3401"        gradientUnits="userSpaceOnUse"        gradientTransform="matrix(0.98959455,0,0,1.1096972,279.05272,-122.63917)"        x1="45"        y1="143"        x2="413"        y2="143" />   </defs>   <metadata      id="metadata35">     <rdf:RDF>       <cc:Work          rdf:about="">         <dc:format>image/svg+xml</dc:format>         <dc:type            rdf:resource="http://purl.org/dc/dcmitype/StillImage" />         <dc:title></dc:title>         <dc:publisher>           <cc:Agent>             <dc:title></dc:title>           </cc:Agent>         </dc:publisher>         <dc:rights>           <cc:Agent>             <dc:title>AGPL</dc:title>           </cc:Agent>         </dc:rights>         <dc:creator>           <cc:Agent>             <dc:title>positivestuido.co</dc:title>           </cc:Agent>         </dc:creator>         <dc:date>2017</dc:date>         <dc:subject>           <rdf:Bag>             <rdf:li>sketch drawing board real-time canvas surface</rdf:li>           </rdf:Bag>         </dc:subject>       </cc:Work>     </rdf:RDF>   </metadata>   <g      inkscape:label="Layer 1"      inkscape:groupmode="layer"      id="layer1"      transform="translate(-359.92474,-9.2357351)">     <path        inkscape:connector-curvature="0"        id="path4215"        style="fill:url(#linearGradientRainbow);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 348.50715,25.511773 0,5.415323 -1.78128,0 0,-3.417866 -16.30852,0 0,7.412776 18.0898,0 0,11.407687 -24.70029,0 0,-5.415322 1.78127,0 0,3.417866 16.30852,0 0,-7.412776 -18.08979,0 0,-11.407688 24.70029,0 z" />     <path        inkscape:connector-curvature="0"        id="path4217"        style="fill:url(#linearGradient3401);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 380.66401,44.332237 0,1.997456 -9.65843,0 0,-1.997456 3.04795,0 -4.71047,-7.412776 -7.32301,0 0,7.412776 3.95839,0 0,1.997456 -14.48766,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.52927,0 0,19.441893 7.28343,0 4.39379,-7.412776 -3.20628,0 0,-1.997457 9.65844,0 0,1.997457 -4.31462,0 -4.94798,8.344922 5.3834,8.478085 4.39378,0 z" />     <path        inkscape:connector-curvature="0"        id="path4219"        style="fill:url(#linearGradient3399);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 384.07627,25.511773 24.70027,0 0,11.407688 -18.08978,0 0,7.412776 16.30851,0 0,-3.417866 1.78127,0 0,5.415322 -24.70027,0 0,-20.81792 z m 6.61049,1.997457 0,7.412776 16.30851,0 0,-7.412776 -16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4221"        style="fill:url(#linearGradient3397);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 429.88582,44.332237 0,1.997456 -14.25015,0 0,-18.820463 -3.91879,0 0,-1.997457 3.91879,0 0,-10.03166 6.61049,0 0,10.03166 7.63966,0 0,1.997457 -7.63966,0 0,16.823007 7.63966,0 z" />     <path        inkscape:connector-curvature="0"        id="path4223"        style="fill:url(#linearGradient3395);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 456.01112,40.914371 1.78128,0 0,5.415322 -24.70029,0 0,-20.81792 24.70029,0 0,5.415323 -1.78128,0 0,-3.417866 -16.30851,0 0,16.823007 16.30851,0 0,-3.417866 z" />     <path        inkscape:connector-curvature="0"        id="path4225"        style="fill:url(#linearGradient3393);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 493.35532,44.332237 0,1.997456 -10.25221,0 0,-1.997456 4.23547,0 0,-16.823007 -16.3085,0 0,16.823007 3.91879,0 0,1.997456 -14.44809,0 0,-1.997456 3.91879,0 0,-26.854671 -3.91879,0 0,-1.997453 10.5293,0 0,10.03166 18.08978,0 0,18.820464 4.23546,0 z" />     <path        inkscape:connector-curvature="0"        id="path4227"        style="fill:url(#linearGradient3391);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 494.28615,54.3639 3.9188,0 0,-26.85467 -3.9188,0 0,-1.997457 29.17326,0 0,20.81792 -18.64395,0 0,8.034207 3.91879,0 0,1.997454 -14.4481,0 0,-1.997454 z m 27.39199,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4229"        style="fill:url(#linearGradient3389);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 552.68831,44.332237 3.91882,0 0,1.997456 -28.61909,0 0,-11.407687 18.08978,0 0,-7.412776 -16.30851,0 0,3.417866 -1.78127,0 0,-5.415323 24.70027,0 0,18.820464 z m -6.61049,0 0,-7.412776 -16.30851,0 0,7.412776 16.30851,0 z" />     <path        inkscape:connector-curvature="0"        id="path4231"        style="fill:url(#linearGradient3387);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 577.98669,25.511773 0,-8.034207 -3.91879,0 0,-1.997453 10.52928,0 0,28.852124 3.91879,0 0,1.997456 -29.17325,0 0,-20.81792 18.64397,0 z m -16.86269,18.820464 16.86269,0 0,-16.823007 -16.86269,0 0,16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4233"        style="fill:url(#linearGradient3385);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 599.21968,46.329693 -7.60009,0 0,-6.791347 7.60009,0 0,6.791347 z" />     <path        inkscape:connector-curvature="0"        id="path4235"        style="fill:url(#linearGradient3383);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 601.71129,54.3639 3.91879,0 0,-26.85467 -3.91879,0 0,-1.997457 29.17325,0 0,20.81792 -18.64396,0 0,8.034207 3.91878,0 0,1.997454 -14.44807,0 0,-1.997454 z m 27.39197,-26.85467 -16.86268,0 0,16.823007 16.86268,0 0,-16.823007 z" />     <path        inkscape:connector-curvature="0"        id="path4237"        style="fill:url(#linearGradient3381);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 659.83544,25.511773 0,5.370936 -1.78128,0 0,-3.373479 -12.86473,0 0,16.823007 3.91879,0 0,1.997456 -14.44807,0 0,-1.997456 3.91879,0 0,-16.823007 -3.91879,0 0,-1.997457 25.17529,0 z" />     <path        inkscape:connector-curvature="0"        id="path4239"        style="fill:url(#linearGradient3379);fill-opacity:1;stroke:#000000;stroke-width:0.62875605;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"        d="m 687.87312,46.329693 -24.70028,0 0,-20.81792 24.70028,0 0,20.81792 z m -1.78128,-18.820463 -16.3085,0 0,16.823007 16.3085,0 0,-16.823007 z" />   </g> </svg> '};
window.NSSketchpad=NSSketchpad;function randomH(){var a=Colorpalette.prototype.HSVtoRGB(360*Math.random(),90,100);return{r:parseInt(a.r,10),g:parseInt(a.g,10),b:parseInt(a.b,10),a:1}}function randomColor(){return randomH()}window.randomColor=randomColor;var supportsPassive=!1;try{var opts=Object.defineProperty({},"passive",{get:function(){supportsPassive=!0}});window.addEventListener("test",null,opts)}catch(a){console.log("ignore",a)}window.supportsPassive=supportsPassive;
function elementOffset(a){a=a.getBoundingClientRect();return{x:0-a.left,y:0-a.top}}
function addEvent(a,b,c,d){function e(){var k="";window.getSelection?k=window.getSelection().toString():void 0!==document.selection&&"Text"===document.selection.type&&(k=document.selection.createRange().text);return k}function g(k){var l,m=elementOffset(a);for(l=0;l<k.changedTouches.length;l+=1){var n=k.changedTouches[l];n.offsetX=n.clientX+m.x;n.offsetY=n.clientY+m.y;c(n)}}var f,h;switch(b){case "swipe-right":console.log("adding swipe right");a.addEventListener("touchstart",function(k){f=k.changedTouches[0]},
d);a.addEventListener("mousedown",function(k){console.log("mdsr");f=k},d);a.addEventListener("touchend",function(k){(h=k.changedTouches[k.changedTouches.length-1])&&f&&30<h.screenX-f.screenX&&!e()&&"text"!==document.activeElement.type&&c(k)},d);a.addEventListener("mouseup",function(k){(h=k)&&f&&30<h.screenX-f.screenX&&!e()&&"text"!==document.activeElement.type&&c(k)},d);break;case "hover-in":a.addEventListener("touchstart",function(k){var l;for(l=0;l<k.changedTouches.length;l+=1)c(k.changedTouches[l])},
d);a.addEventListener("touchmove",function(k){var l;for(l=0;l<k.changedTouches.length;l+=1)c(k.changedTouches[l])},d);a.addEventListener("mouseover",c,d);break;case "hover-out":a.addEventListener("mouseout",c,d);break;case "tap":a.addEventListener("touchstart",function(k){k.preventDefault();document.activeElement!==k.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur();var l;for(l=0;l<k.changedTouches.length;l+=1)k.changedTouches[l].stopPropagation=k.stopPropagation&&k.stopPropagation.bind(k),
k.changedTouches[l].preventDefault=k.preventDefault&&k.preventDefault.bind(k),c(k.changedTouches[l]);k.preventMouseFallback=!0},d);a.addEventListener("mousedown",function(k){c(k)},d);break;case "pop":a.addEventListener("touchend",function(k){k.preventDefault();document.activeElement!==k.target&&"INPUT"===document.activeElement.tagName&&document.activeElement.blur();var l;for(l=0;l<k.changedTouches.length;l+=1)k.changedTouches[l].stopPropagation=k.stopPropagation&&k.stopPropagation.bind(k),k.changedTouches[l].preventDefault=
k.preventDefault&&k.preventDefault.bind(k),c(k.changedTouches[l]);k.preventMouseFallback=!0},d);a.addEventListener("mouseup",function(k){c(k)},d);break;case "slide":a.addEventListener("mousedown",c,d);a.addEventListener("mouseup",c,d);a.addEventListener("mousemove",function(k){(k.buttons||void 0===k.buttons&&k.which)&&c(k)},d);a.addEventListener("touchstart",g,d);a.addEventListener("touchend",g,d);a.addEventListener("touchmove",g,d);break;default:a.addEventListener(b,c,d)}}window.addEvent=addEvent;
function Eventsmanager(){this.registeredCallbacks={};this.registeredCallbacksOnce={}}
Eventsmanager.prototype={on:function(a,b){this.registeredCallbacks[a]||(this.registeredCallbacks[a]=[]);this.registeredCallbacks[a].push(b);return this},removeListener:function(a,b){if(this.registeredCallbacks[a]){var c;for(c=this.registeredCallbacks[a].length-1;0<=c;--c)this.registeredCallbacks[a][c]===b&&this.registeredCallbacks[a].splice(c,1);this.registeredCallbacks[a].indexOf(b)}},once:function(a,b,c){this.registeredCallbacksOnce[a]||(this.registeredCallbacksOnce[a]=[]);var d=!1;c&&this.registeredCallbacksOnce[a].forEach(function(e){e.id===
c&&(e.fn=b,d=!0)});d||this.registeredCallbacksOnce[a].push({id:c,fn:b});return this},dispatch:function(a,b,c,d){var e=this;this.registeredCallbacks[a]&&this.registeredCallbacks[a].forEach(function(g){g.call(e,b,c,d)});this.registeredCallbacksOnce[a]&&(this.registeredCallbacksOnce[a].forEach(function(g){g.fn.call(e,b,c,d)}),delete this.registeredCallbacksOnce[a]);return this}};window.Eventsmanager=Eventsmanager;
function Resources(a){this.images=[];this.config=a;this.sketchpad=a.sketchpad;return this}
Object.assign(Resources.prototype,{getImage:function(a,b,c){function d(k){b(f);g.sketchpad.planRefreshWindow(0,"resources.js:getImage:onImageLoadedOnce")}var e,g=this;for(e=0;e<this.images.length;e+=1){var f=this.images[e];if(f.url===a){if(f.loaded)if(f.success)b(f);else{if("function"===typeof c)return c(f)}else f.img.addEventListener("load",d);return}}e=new Image;e.crossOrigin="anonymous";var h=new Progressbar({progressParentEl:this.sketchpad.progressParentEl});h.startFakeProgress();f={url:a,loaded:!1,
progressbar:h,img:e};e.src=a;e.addEventListener("load",function(k){f.loaded=!0;f.success=!0;console.log("on image loaded");f.loadEvent=k;f.progressbar.uploadComplete();d(k)});e.addEventListener("error",function(k){f.loaded=!0;f.success=!1;f.loadEvent=k;f.progressbar.cancel();if("function"===typeof c)return c(f)});this.images.push(f)}});window.Resources=Resources;
function Imagehost(a){Eventsmanager.call(this,a);this.File=void 0;this.config=a;this.postPdfUrl=NSSketchpad&&NSSketchpad.postPdfUrl||"https://uploader.imagehost.pro:3443/upload";this.postImageUrl=NSSketchpad&&NSSketchpad.postImageUrl||"https://uploader.imagehost.pro:3443/upload";this.postWebshotUrl=NSSketchpad&&NSSketchpad.postWebshotUrl||"https://uploader.imagehost.pro:3443/webshot?site=";this.proxyImageUrl=NSSketchpad&&NSSketchpad.proxyImageUrl||"https://imagehost.pro/proxy";this.proxyExcludedDomain=
NSSketchpad&&NSSketchpad.proxyExcludedDomain||"imagehost.pro";a.file&&this.uploadFile(a.file);if(a.url)if(this.isDataURL(a.url))if(a.file=this.dataURItoFile(a.url),a.file)this.uploadFile(a.file);else return console.error("Error - wrong data url",a.url),this;else this.proxyUrl(a.url);this.progressbar=new Progressbar({name:a.url,progressParentEl:a.progressParentEl||window.document.body,style:{position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(155, 0, 0, 0.5)"}});
return this}Imagehost.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Imagehost.prototype,{isDataURL:function(a){return!!a.match(/^\s*data:([a-z]+\/[a-z]+(;[a-z\-]+=[a-z\-]+)?)?(;base64)?,[a-z0-9!\$&',\(\)\*\+,;=\-\._~:@\/\?%\s]*\s*$/i)},dataURItoFile:function(a){if("string"!==typeof a)this.dispatch("error",{type:"upload",message:"dataURI must be a string."});else{a=a.split(",");var b=a[0].split(":")[1].split(";")[0];a=atob(a[1]);var c=a.length,d=new ArrayBuffer(c);d=new Uint8Array(d);var e;for(e=0;e<c;e+=1)d[e]=a.charCodeAt(e);return new File([d],"file",
{type:b})}},proxyUrl:function(a){function b(e){setTimeout(function(){d.dispatch("success",{status:"ok",url:e})},0)}var c=document.createElement("a");c.href=a;var d=this;-1!==String(c.hostname).indexOf(this.proxyExcludedDomain)?b(a):b(this.proxyImageUrl+"?url="+encodeURIComponent(a))},uploadProgress:function(a){this.dispatch("progress",a.loaded/a.total)},uploadFile:function(a){this.File=a;(new FormData).append("fileToUpload",a);var b=new XMLHttpRequest,c=this;b.upload.addEventListener("progress",function(e){c.uploadProgress(e);
c.progressbar.uploadProgress(e)},!1);b.addEventListener("load",function(e){console.log("uploading load",e);c.uploadComplete(e);c.progressbar.uploadComplete(e)},!1);b.addEventListener("error",function(e){console.log("uploading error",e);c.uploadFailed(e);c.progressbar.uploadFailed(e)},!1);b.addEventListener("abort",function(e){c.uploadCanceled(e);c.progressbar.uploadCanceled(e)},!1);switch(String(a.type)){case "application/pdf":var d=this.postPdfUrl;break;default:d=this.postImageUrl}b.open("POST",
d);b.setRequestHeader("Content-Type",a.type);b.setRequestHeader("Content-Name",encodeURI(a.name));b.setRequestHeader("Content-Size",a.size);b.setRequestHeader("Content-LastModified",a.lastModified);b.send(a);this.dispatch("upload",b)},uploadComplete:function(a){var b={};try{b=JSON.parse(a.target.response)}catch(c){this.dispatch("error",{type:"parse",title:"Upload fail",message:"Uknown response from server.",err:c})}b&&"ok"===b.status?this.dispatch("success",b):this.dispatch("error",{type:"response",
title:"Upload fail",message:b&&b.message||"Your upload was rejected by server.",response:b})},uploadFailed:function(a){console.error("uploadFailed",a);this.dispatch("error",{type:"fail",title:"Upload fail",message:"There was an error attempting to upload the file.",e:a})},uploadCanceled:function(a){this.dispatch("error",{type:"cancelled",title:"Upload cancelled",message:"The upload has been canceled by the user or the browser dropped the connection.",e:a})}});window.Imagehost=Imagehost;
function Progressbar(a){Eventsmanager.call(this,a);this.config=Object.assign({},a);this.prepareLoadingElements();return this}Progressbar.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Progressbar.prototype,{prepareLoadingElements:function(){this.id=parseInt(1E3*Math.random(),10);this.loadingBarEl=document.createElement("div");var a=Object.assign({position:"absolute",top:0,left:0,zIndex:200,height:"2px",width:"2px",backgroundColor:"rgba(0, 0, 155, 0.5)",transition:"width 0.4s ease-in-out",webkitTransition:"width 0.4s ease-in-out",MozTransition:"width 0.5s ease-in-out",msTransition:"width 0.5s ease-in-out",OTransition:"width 0.5s ease-in-out"},this.config.style);Object.assign(this.loadingBarEl.style,
a);this.config.progressParentEl||(this.config.progressParentEl=window.document.body);this.config.progressParentEl.appendChild(this.loadingBarEl)},uploadProgress:function(a){this.dispatch("progress",a.loaded/a.total);this.loadingBarEl.style.width=parseInt(a.loaded/a.total*100,10)+"%"},uploadCompleteDestructor:function(){this.config.progressParentEl.removeChild(this.loadingBarEl)},uploadComplete:function(){this.completed||(this.completed=!0,this.uploadProgress({loaded:1,total:1}),clearInterval(this.fakeProgressTo),
setTimeout(this.uploadCompleteDestructor.bind(this),500))},startFakeProgress:function(){var a=this;a.fakeProgress=0;a.fakeTotal=100;this.fakeProgressTo=setInterval(function(){a.fakeProgress+=.01*(a.fakeTotal-a.fakeProgress);a.uploadProgress({loaded:a.fakeProgress,total:a.fakeTotal})},100)},cancel:function(a){this.completed||(console.log("%cCANCEL","background-color:orange",this.id,a),clearInterval(this.fakeProgressTo),this.config.progressParentEl.removeChild(this.loadingBarEl),this.completed=!0)},
uploadCanceled:function(a){this.cancel(a)},uploadFailed:function(a){this.cancel(a)}});window.Progressbar=Progressbar;function Keyshortcuts(a){Eventsmanager.call(this,a);this.shortcuts=[];this.registerEvents()}Keyshortcuts.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Keyshortcuts.prototype,{disabled:!1,disable:function(){"use strct";this.disabled=!0},enable:function(){"use strct";this.disabled=!1},isMac:function(){"use strct";return-1!==navigator.appVersion.indexOf("Mac")},checkIfPressed:function(a,b){return"optional"!==a.metaKey&&!!a.metaKey!==!!b.metaKey||"optional"!==a.altKey&&!!a.altKey!==!!b.altKey||"optional"!==a.shiftKey&&!!a.shiftKey!==!!b.shiftKey||"optional"!==a.ctrlKey&&!!a.ctrlKey!==!!b.ctrlKey||a.keyCode!==b.keyCode?!1:!0},onKeyDown:function(a){if(this.disabled)return!1;
var b;for(b=0;b<this.shortcuts.length;b+=1){var c=this.shortcuts[b];c.pressed&&!c.repeatable||!this.checkIfPressed(c,a)||(c.pressed=!0,"function"===typeof c.callbackDown&&c.callbackDown(a))}},onKeyUp:function(a){if(this.disabled)return!1;var b;for(b=0;b<this.shortcuts.length;b+=1){var c=this.shortcuts[b];c.pressed&&(this.checkIfPressed(c,a),1)&&(c.pressed=!1,"function"===typeof c.callbackUp&&c.callbackUp(a))}},registerEvents:function(){var a=this;window.addEventListener("keydown",function(b){if("INPUT"!==
document.activeElement.tagName)return a.onKeyDown(b)});window.addEventListener("keyup",function(b){if("INPUT"!==document.activeElement.tagName)return a.onKeyUp(b)})},getKeycodeStr:function(a){switch(a){case 32:a="space";break;case 91:a=this.isMac()?"\u2318":"WIN";break;case 18:a=this.isMac()?"\u2325":"ALT";break;case 16:a=this.isMac()?"\u21ea":"SHIFT";break;case 17:a=this.isMac()?"ctrl":"CTRL";break;case 27:a="Esc";break;case 20:a=this.isMac()?"\u21ea":"Caps lock";break;case 13:a="\u23ce";break;case 8:a=
"\u232b";break;case 187:a="+";break;case 189:a="-";break;default:a=String.fromCharCode(a)}return a},getShortcutStr:function(a){var b=[];!0===a.metaKey&&b.push(this.isMac()?"\u2318":"WIN");!0===a.altKey&&b.push(this.isMac()?"\u2325":"ALT");!0===a.ctrlKey&&b.push(this.isMac()?"ctrl":"CTRL");!0===a.shiftKey&&b.push(this.isMac()?"\u21ea":"SHIFT");a.keyCode&&b.push(this.getKeycodeStr(a.keyCode));return b.join(" + ")},addShortcut:function(a,b,c){a.callbackDown=b;a.callbackUp=c;this.shortcuts.push(a)}});
window.Keyshortcuts=Keyshortcuts;
function Colorpalette(a){function b(f){g.changeAlpha(g.color.alpha-f.deltaX/100/2);f.preventDefault()}function c(f){g.changeHue(g.color.hue-f.deltaY/2);f.preventDefault()}function d(f){g.pickPalette(g.color.saturation-f.deltaX/2,g.color.value-f.deltaY/2);f.preventDefault()}Eventsmanager.call(this,a);"object"!==typeof a.keyModifiers&&(a.keyModifiers={});var e=a.containerEl;this.containerEl=e;e.classList.add("colorpalette");this.width=200;this.height=220;this.color={hue:0,saturation:0,value:0,red:0,
green:0,blue:0,alpha:1};e.style.position="relative";e.style.width="200px";e.style.height="220px";e.style.display="inline-block";this.colorBgEl=document.createElement("div");this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')";this.colorBgEl.style.backgroundSize=
"16px";this.colorBgEl.style.backgroundPosition="50% 50%";this.colorBgEl.className="color-bg";this.colorBgEl.style.width="200px";this.colorBgEl.style.height=Math.floor(1/11*220)+"px";this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px";this.colorBgEl.style.overflow="hidden";this.colorEl=document.createElement("div");this.colorEl.className="color";this.colorEl.style.width="100%";this.colorEl.style.height="100%";this.colorEl.style.cursor="pointer";this.colorBgEl.appendChild(this.colorEl);
this.colorBgEl.style.position="absolute";this.colorBgEl.style.top="0px";this.colorBgEl.style.left="0px";this.paletteCanvas=document.createElement("canvas");this.paletteCanvas.className="palette";this.paletteCanvas.width=180;this.paletteCanvas.height=Math.floor(9/11*220);this.paletteContext2d=this.paletteCanvas.getContext("2d");this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height);this.paletteCanvas.style.cursor="crosshair";this.paletteCanvas.style.position=
"absolute";this.paletteCanvas.style.left="0px";this.paletteCanvas.style.top=Math.floor(1/11*220)+"px";this.palettePointerEl=document.createElement("div");this.palettePointerEl.className="pointer palette-pointer";this.palettePointerEl.position="absolute";this.palettePointerEl.style.width="12px";this.palettePointerEl.style.height="12px";this.palettePointerEl.style.backgroundColor="white";this.palettePointerEl.style.position="absolute";this.palettePointerEl.style.borderRadius="50%";this.palettePointerEl.style.cursor=
"crosshair";this.palettePointerEl.style.boxShadow="inset 0 0 2px #000";this.hueCanvas=document.createElement("canvas");this.hueCanvas.className="hue";this.hueCanvas.width=20;this.hueCanvas.height=9/11*220;this.hueContext2d=this.hueCanvas.getContext("2d");this.hueIData=this.hueContext2d.createImageData(this.hueCanvas.width,this.hueCanvas.height);this.hueCanvas.style.cursor="row-resize";this.hueCanvas.style.position="absolute";this.hueCanvas.style.top=1/11*220+"px";this.hueCanvas.style.left="180px";
this.hueSliderEl=document.createElement("div");this.hueSliderEl.className="slider hue-slider";this.hueSliderEl.style.width="24px";this.hueSliderEl.style.height="6.6px";this.hueSliderEl.style.position="absolute";this.hueSliderEl.style.top="22px";this.hueSliderEl.style.left="178px";this.hueSliderEl.style.backgroundColor="white";this.hueSliderEl.style.cursor="row-resize";this.hueSliderEl.style.boxShadow="inset 0 0 2px #000";this.hueSliderEl.style.zIndex=100;this.alphaCanvas=document.createElement("canvas");
this.alphaCanvas.className="alpha";this.alphaCanvas.width=200;this.alphaCanvas.height=1/11*220;this.alphaContext2d=this.alphaCanvas.getContext("2d");this.alphaIData=this.alphaContext2d.createImageData(this.alphaCanvas.width,this.alphaCanvas.height);this.alphaCanvas.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')";
this.alphaCanvas.style.backgroundSize="16px";this.alphaCanvas.style.backgroundPosition="50% 50%";this.alphaCanvas.style.cursor="col-resize";this.alphaCanvas.style.position="absolute";this.alphaCanvas.style.top=10/11*220+"px";this.alphaCanvas.style.left="0px";this.alphaCanvas.style.borderRadius="0px 0px "+window.radius+"px "+window.radius+"px";this.alphaCanvas.style.overflow="hidden";this.alphaSliderEl=document.createElement("div");this.alphaSliderEl.className="slider alpha-slider";this.alphaSliderEl.style.width=
"6px";this.alphaSliderEl.style.height="24.2px";this.alphaSliderEl.style.backgroundColor="white";this.alphaSliderEl.style.position="absolute";this.alphaSliderEl.style.top=10/11*220-2.2+"px";this.alphaSliderEl.style.left=this.alphaCanvas.width-3+"px";this.alphaSliderEl.style.cursor="col-resize";this.alphaSliderEl.style.boxShadow="inset 0 0 2px #000";this.alphaSliderEl.style.zIndex=100;this.redInput=document.createElement("input");this.redInput.title="R:";this.greenInput=document.createElement("input");
this.greenInput.title="G:";this.blueInput=document.createElement("input");this.blueInput.title="B:";this.alphaInput=document.createElement("input");this.alphaInput.title="A:";this.valuesEl=document.createElement("div");var g=this;[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(f){var h=document.createElement("span");h.textContent=f.title;g.valuesEl.appendChild(h);g.valuesEl.appendChild(f);f.type="number";f.className=f.title;f===g.alphaInput?(f.min=0,f.max=1,f.step=
.01,f.maxLength=4):(f.min=0,f.max=255,f.step=1,f.maxLength=3);f.addEventListener("change",function(){g.updateFromInputs()})});e.appendChild(this.colorBgEl);e.appendChild(this.paletteCanvas);e.appendChild(this.hueCanvas);e.appendChild(this.alphaCanvas);e.appendChild(this.hueSliderEl);e.appendChild(this.alphaSliderEl);e.appendChild(this.palettePointerEl);this.drawHue();this.drawPalette(this.color.hue);addEvent(this.hueCanvas,"slide",function(f){f=g.normalize(f.offsetY,0,g.hueCanvas.height)/g.hueCanvas.height*
360;g.changeHue(f)});addEvent(this.colorEl,"tap",function(){var f=g.getColor();g.dispatch("set",{color:f})});addEvent(this.paletteCanvas,"slide",function(f){var h=g.normalize(f.offsetX,0,g.paletteCanvas.width);f=g.normalize(f.offsetY,0,g.paletteCanvas.height);g.pickPalette(h/g.paletteCanvas.width*100,f/g.paletteCanvas.height*100)});addEvent(this.alphaCanvas,"slide",function(f){f=g.normalize(f.offsetX,0,g.alphaCanvas.width)/g.alphaCanvas.width;g.changeAlpha(f)});this.setHueSlider(0);a.color&&this.setColor(a.color);
this.alphaCanvas.addEventListener("wheel",b);this.alphaSliderEl.addEventListener("wheel",b);this.hueCanvas.addEventListener("wheel",c);this.hueSliderEl.addEventListener("wheel",c);this.paletteCanvas.addEventListener("wheel",d);this.palettePointerEl.addEventListener("wheel",d);this.keyshortcuts=new Keyshortcuts;this.keyshortcuts.disable();this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:38,repeatable:!0},a.keyModifiers),function(){g.changeHue(g.color.hue-1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!1,
keyCode:40,repeatable:!0},a.keyModifiers),function(){g.changeHue(g.color.hue+1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},a.keyModifiers),function(){g.changeAlpha(g.color.alpha-.01)});this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},a.keyModifiers),function(){g.changeAlpha(g.color.alpha+.01)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},a.keyModifiers),function(){g.pickPalette(g.color.saturation,
g.color.value-1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},a.keyModifiers),function(){g.pickPalette(g.color.saturation,g.color.value+1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},a.keyModifiers),function(){g.pickPalette(g.color.saturation-1,g.color.value)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},a.keyModifiers),function(){g.pickPalette(g.color.saturation+1,g.color.value)});return this}
Colorpalette.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Colorpalette.prototype,{normalize:function(a,b,c){a<b&&(a=b);a>c&&(a=c);return a},pickPalette:function(a,b){a=this.normalize(a,0,100);b=this.normalize(b,0,100);this.color.saturation=a;this.color.value=b;var c=this.HSVtoRGB(this.color.hue,this.color.saturation,this.color.value);this.setPalettePointer(this.color.saturation,this.color.value);c.a=this.color.alpha;this.setColor(c)},changeHue:function(a){a%=360;0>a&&(a+=360);this.setHueSlider(a);this.color.hue=a;this.drawPalette(a);a=this.HSVtoRGB(a,
this.color.saturation,this.color.value);a.a=this.color.alpha;this.setColor(a)},changeAlpha:function(a){a=this.normalize(a,0,1);this.color.alpha=a;this.setAlpha(a)},focus:function(){this.isFocused=!0},blur:function(){this.isFocused=!1},getColor:function(){return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,10),alpha:parseFloat(this.color.alpha)}},HSVtoRGB:function(a,b,c){c/=100;b=b/100*c;a/=60;var d=b*(1-Math.abs(a%2-1));c-=b;b=255*(b+c);d=255*(d+
c);c*=255;return 0<=a&&1>a?{r:b,g:d,b:c}:1<=a&&2>a?{r:d,g:b,b:c}:2<=a&&3>a?{r:c,g:b,b:d}:3<=a&&4>a?{r:c,g:d,b:b}:4<=a&&5>a?{r:d,g:c,b:b}:5<=a&&6>a?{r:b,g:c,b:d}:{r:0,g:0,b:0}},RGBtoHSV:function(a,b,c){a/=255;b/=255;var d=c/255;c=Math.max(a,b,d);var e=c-Math.min(a,b,d),g=0,f=0;e&&(c===a&&(g=(b-d)/e),c===b&&(g=2+(d-a)/e),c===d&&(g=4+(a-b)/e),c&&(f=e/c));a=60*g;0>a&&(a+=360);return{h:a,s:100*f,v:100*c}},putPixel:function(a,b,c,d){b=4*(b+c*a.width);a.data[b]=d.r;a.data[b+1]=d.g;a.data[b+2]=d.b;a.data[b+
3]=d.a},drawHue:function(){var a,b;for(a=0;a<this.hueCanvas.width;a+=1)for(b=0;b<this.hueCanvas.height;b+=1){var c=this.HSVtoRGB(b/this.hueCanvas.height*360,100,100);this.putPixel(this.hueIData,a,b,{r:c.r,g:c.g,b:c.b,a:255})}this.hueContext2d.putImageData(this.hueIData,0,0)},setAlphaSlider:function(a){this.alphaSliderEl.style.left=a/1*this.alphaCanvas.width-.015*this.width+"px"},setAlpha:function(a){a=Math.round(100*a)/100;this.color.alpha=a;this.setColor({r:this.color.red,g:this.color.green,b:this.color.blue,
a:this.color.alpha})},setHueSlider:function(a){this.hueSliderEl.style.top=1/11*this.height+a/360*this.hueCanvas.height-.015*this.height+"px"},setPalettePointer:function(a,b){var c=b/100*this.paletteCanvas.height;this.palettePointerEl.style.left=.03*-this.width+a/100*this.paletteCanvas.width+"px";this.palettePointerEl.style.top=.03*-this.height+.1*this.height+c+"px"},triggerUpdate:function(){var a=this.getColor();this.dispatch("change",{color:a})},updateFromInputs:function(){this.setColor({r:this.redInput.value,
g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value});this.setAlpha(this.alphaInput.value)},setColor:function(a,b){var c={h:this.color.hue,s:this.color.saturation,v:this.color.value};if(a.r||a.g||a.b)c=this.RGBtoHSV(a.r,a.g,a.b);a.r===a.g&&a.g===a.b&&(c.h=this.color.hue);this.color.red=a.r;this.color.green=a.g;this.color.blue=a.b;this.color.alpha=a.a;this.color.hue=c.h;this.color.saturation=c.s;this.color.value=c.v;this.redInput.value=a.r;this.greenInput.value=a.g;this.blueInput.value=
a.b;this.alphaInput.value=a.a;this.setHueSlider(c.h);this.drawPalette(c.h);this.darwAlpha(a);this.setAlphaSlider(a.a);this.setPalettePointer(c.s,c.v);this.getColor();this.colorEl.style.backgroundColor="rgba(0,0,0,1)";b||this.triggerUpdate()},drawPalette:function(a){var b,c;for(b=0;b<this.paletteCanvas.width;b+=1)for(c=0;c<this.paletteCanvas.height;c+=1){var d=this.HSVtoRGB(a,b/this.paletteCanvas.width*100,c/this.paletteCanvas.height*100);this.putPixel(this.paletteIData,b,c,{r:d.r,g:d.g,b:d.b,a:255})}this.paletteContext2d.putImageData(this.paletteIData,
0,0)},darwAlpha:function(a){var b,c;for(b=0;b<this.alphaCanvas.width;b+=1)for(c=0;c<this.alphaCanvas.height;c+=1)this.putPixel(this.alphaIData,b,c,{r:a.r,g:a.g,b:a.b,a:b/this.alphaCanvas.width*255});this.alphaContext2d.putImageData(this.alphaIData,0,0)}});window.Colorpalette=Colorpalette;
function Pixelpicker(a){function b(f){e.changeThreshold(e.threshold-f.deltaX/100/2);f.preventDefault()}function c(f){e.pickPalette(e.x-f.deltaX/2,e.y-f.deltaY/2);f.preventDefault()}Eventsmanager.call(this,a);"object"!==typeof a.keyModifiers&&(a.keyModifiers={});var d=a.containerEl;this.containerEl=d;d.classList.add("Pixelpicker");this.width=200;this.height=220;this.threshold=.15;this.y=this.x=0;this.color={hue:0,saturation:0,value:0,red:0,green:0,blue:0,alpha:1};d.style.position="relative";d.style.width=
"200px";d.style.height="220px";d.style.display="inline-block";this.colorBgEl=document.createElement("div");this.colorBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')";this.colorBgEl.style.backgroundSize="16px";this.colorBgEl.style.backgroundPosition="50% 50%";
this.colorBgEl.className="color-bg";this.colorBgEl.style.width="200px";this.colorBgEl.style.height=Math.floor(1/11*220)+"px";this.colorBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px";this.colorBgEl.style.overflow="hidden";this.colorEl=document.createElement("div");this.colorEl.className="color";this.colorEl.style.width="100%";this.colorEl.style.height="100%";this.colorEl.style.cursor="pointer";this.colorBgEl.appendChild(this.colorEl);this.colorBgEl.style.position="absolute";
this.colorBgEl.style.top="0px";this.colorBgEl.style.left="0px";this.paletteBgEl=document.createElement("div");this.paletteBgEl.className="palette-bg";this.paletteBgEl.style.position="absolute";this.paletteBgEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH4AcGEAAdMvv9RwAAAFBJREFUWMPt18EJACAIhWGLNnJah3Im28B36CDE/66CfBCirYgoa5KZ9hJ3b+vbhgMAAICj5lzNsYrqzxMAAAAAAAAA8/eA2vf8CwAA+B5wAUhhDw4II7MzAAAAAElFTkSuQmCC')";this.paletteBgEl.style.backgroundSize=
"16px";this.paletteBgEl.style.backgroundPosition="50% 50%";this.paletteBgEl.style.width="200px";this.paletteBgEl.style.height=Math.floor(10/11*220)+"px";this.paletteBgEl.style.borderRadius=window.radius+"px "+window.radius+"px 0px 0px";this.paletteBgEl.style.overflow="hidden";this.paletteBgEl.style.left="0px";this.paletteBgEl.style.top=Math.floor(1/11*220)+"px";this.paletteCanvas=document.createElement("canvas");this.paletteCanvas.className="palette";this.paletteCanvas.width=200;this.paletteCanvas.height=
Math.floor(10/11*220);this.paletteContext2d=this.paletteCanvas.getContext("2d");this.paletteIData=this.paletteContext2d.createImageData(this.paletteCanvas.width,this.paletteCanvas.height);this.paletteCanvas.style.cursor="crosshair";this.paletteCanvas.style.position="absolute";this.paletteCanvas.style.left="0px";this.paletteCanvas.style.top=Math.floor(1/11*220)+"px";var e=this,g=document.createElement("img");g.addEventListener("load",function(){e.paletteContext2d.drawImage(g,0,0,g.width,g.height,0,
0,e.width,g.height/g.width*e.width)});g.src=a.imageSrc;this.palettePointerEl=document.createElement("div");this.palettePointerEl.className="pointer palette-pointer";this.palettePointerEl.position="absolute";this.palettePointerEl.style.width="12px";this.palettePointerEl.style.height="12px";this.palettePointerEl.style.backgroundColor="transparent";this.palettePointerEl.style.position="absolute";this.palettePointerEl.style.border="1px solid white";this.palettePointerEl.style.borderRadius="50%";this.palettePointerEl.style.cursor=
"crosshair";this.palettePointerEl.style.boxShadow="inset 0 0 2px #000";this.thresholdSliderEl=document.createElement("div");this.thresholdSliderEl.className="slider alpha-slider";this.thresholdSliderEl.style.width="6px";this.thresholdSliderEl.style.height="24.2px";this.thresholdSliderEl.style.backgroundColor="transparent";this.thresholdSliderEl.style.border="1px solid white";this.thresholdSliderEl.style.position="absolute";this.thresholdSliderEl.style.top="-2.2px";this.thresholdSliderEl.style.left=
this.width-3+"px";this.thresholdSliderEl.style.cursor="col-resize";this.thresholdSliderEl.style.boxShadow="inset 0 0 2px #000";this.thresholdSliderEl.style.zIndex=100;this.redInput=document.createElement("input");this.redInput.title="R:";this.greenInput=document.createElement("input");this.greenInput.title="G:";this.blueInput=document.createElement("input");this.blueInput.title="B:";this.alphaInput=document.createElement("input");this.alphaInput.title="A:";this.valuesEl=document.createElement("div");
[this.redInput,this.greenInput,this.blueInput,this.alphaInput].forEach(function(f){var h=document.createElement("span");h.textContent=f.title;e.valuesEl.appendChild(h);e.valuesEl.appendChild(f);f.type="number";f.className=f.title;f===e.alphaInput?(f.min=0,f.max=1,f.step=.01,f.maxLength=4):(f.min=0,f.max=255,f.step=1,f.maxLength=3);f.addEventListener("change",function(){e.updateFromInputs()})});d.appendChild(this.colorBgEl);d.appendChild(this.paletteBgEl);d.appendChild(this.paletteCanvas);d.appendChild(this.thresholdSliderEl);
d.appendChild(this.palettePointerEl);addEvent(this.paletteCanvas,"slide",function(f){var h=e.normalize(f.offsetX,0,e.paletteCanvas.width);f=e.normalize(f.offsetY,0,e.paletteCanvas.height);e.pickPalette(h,f)});addEvent(this.colorEl,"slide",function(f){f=e.normalize(f.offsetX,0,e.width)/e.width;e.changeThreshold(f)});this.colorEl.addEventListener("wheel",b);this.thresholdSliderEl.addEventListener("wheel",b);this.setThresholdSlider(0);a.color&&this.setColor(a.color);this.paletteCanvas.addEventListener("wheel",
c);this.palettePointerEl.addEventListener("wheel",c);this.keyshortcuts=new Keyshortcuts;this.keyshortcuts.disable();this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:37,repeatable:!0},a.keyModifiers),function(){e.changeThreshold(e.threshold-.01)});this.keyshortcuts.addShortcut(Object.assign({altKey:!1,keyCode:39,repeatable:!0},a.keyModifiers),function(){e.changeThreshold(e.threshold+.01)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:38,repeatable:!0},a.keyModifiers),
function(){e.pickPalette(e.color.saturation,e.color.value-1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:40,repeatable:!0},a.keyModifiers),function(){e.pickPalette(e.color.saturation,e.color.value+1)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:37,repeatable:!0},a.keyModifiers),function(){e.pickPalette(e.color.saturation-1,e.color.value)});this.keyshortcuts.addShortcut(Object.assign({altKey:!0,keyCode:39,repeatable:!0},a.keyModifiers),function(){e.pickPalette(e.color.saturation+
1,e.color.value)});return this}Pixelpicker.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Pixelpicker.prototype,{normalize:function(a,b,c){a<b&&(a=b);a>c&&(a=c);return a},setPalettePointer:function(a,b){this.x=a;this.y=b;this.palettePointerEl.style.left=.03*-this.width+a+"px";this.palettePointerEl.style.top=.03*-this.height+.1*this.height+b+"px"},pickPalette:function(a,b){console.log("pickPalette",a,b);a=this.normalize(a,0,this.width);b=this.normalize(b,0,this.height);var c=this.paletteContext2d.getImageData(a,b,1,1).data;this.setPalettePointer(a,b);this.setColor({r:c[0],
g:c[1],b:c[2],a:c[3]/255})},setThresholdSlider:function(a){this.thresholdSliderEl.style.left=this.width*a-.015*this.width+"px"},setThreshold:function(a){this.threshold=a=Math.round(100*a)/100;this.setThresholdSlider(a)},changeThreshold:function(a){this.threshold=a=this.normalize(a,0,1);this.setThreshold(a)},focus:function(){this.isFocused=!0},blur:function(){this.isFocused=!1},getColor:function(){return{red:parseInt(this.color.red,10),green:parseInt(this.color.green,10),blue:parseInt(this.color.blue,
10),alpha:parseFloat(this.color.alpha)}},putPixel:function(a,b,c,d){b=4*(b+c*a.width);a.data[b]=d.r;a.data[b+1]=d.g;a.data[b+2]=d.b;a.data[b+3]=d.a},triggerUpdate:function(){var a=this.getColor();this.dispatch("change",{color:a})},updateFromInputs:function(){this.setColor({r:this.redInput.value,g:this.greenInput.value,b:this.blueInput.value,a:this.alphaInput.value});this.setAlpha(this.alphaInput.value)},setColor:function(a,b){this.color.red=a.r;this.color.green=a.g;this.color.blue=a.b;this.color.alpha=
a.a;this.redInput.value=a.r;this.greenInput.value=a.g;this.blueInput.value=a.b;this.alphaInput.value=a.a;var c=this.getColor();this.colorEl.style.backgroundColor="rgba("+c.red+","+c.green+","+c.blue+","+c.alpha+")";b||this.triggerUpdate()}});window.Pixelpicker=Pixelpicker;
function Sketch(a){Eventsmanager.call(this,a);this.config=Object.assign({sid:String(Date.now()+Math.random()),cts:Date.now()},a);this.toolsCache=[];this.framesHistory=[];this.newFrames=[];this.myStash=[];this.bulkId=0;this.grindingThreshold=1E3/60;this.userBFramesCounter=0;this.setConfig(this.config);return this}Sketch.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Sketch.prototype,{getHistoryStatus:function(){return{undo:this.userBFramesCounter,redo:this.myStash.length}},getId:function(){return String(this.config.sid)},setConfig:function(a){this.config=Object.assign(this.config,a)},getConfig:function(){return this.config},getPageConfig:function(a){this===a.room.sketch&&this.setConfig(a.getSketchConfig());return{description:"Drawing board sketch page",version:"0.5.1",timestamp:Date.now(),timestampISO:(new Date).toISOString(),host:document.location.host,
cmd:"page",config:this.getConfig()}},getFrames:function(){var a=this.framesHistory.concat(this.newFrames),b,c;for(b=0;b<a.length;b+=1)for(c=0;c<a[b].evs.length;c+=1)void 0!==a[b].evs[c].cid&&Object.assign(a[b].evs[c],this.getCachedFrame(a[b].evs[c].cid)),a[b].cmd="inputs",a[b].sid=this.getId();return a},cacheFrame:function(a){var b=this.toolsCache.findIndex(function(c){return c?c.tol===a.tol&&c.vpx===a.vpx&&c.vpy===a.vpy&&c.scl===a.scl&&c.rot===a.rot&&c.hgt===a.hgt&&c.wdh===a.wdh&&JSON.stringify(c.cnf)===
JSON.stringify(a.cnf)?!0:!1:!1});return-1===b?(this.toolsCache.push({vpx:a.vpx,vpy:a.vpy,scl:a.scl,rot:a.rot,tol:a.tol,hgt:a.hgt,wdh:a.wdh,cnf:a.cnf}),this.toolsCache.length-1):b},getCachedFrame:function(a){return this.toolsCache[a]},reset:function(){this.toolsCache=[];this.myStash=[];this.framesHistory=[];this.newFrames=[];this.grindingThreshold=1E3/60},grindBulkFrame:function(a,b,c){var d;this.bulkId+=1;a.UID===b.uid&&(this.userBFramesCounter||a.dispatch("undoAvaliable"),this.userBFramesCounter+=
1);if(b.evs&&b.evs.length)for(;b.evs.length;){b.evs[0].pts||console.debug("empty first frame `bulkFrame.evs[0].pts`");a=b.evs[0].pts&&b.evs[0].pts.t[0];var e=a+this.grindingThreshold;a={uid:b.uid,bid:this.bulkId,evs:[]};for(d=b.evs.length-1;0<=d;--d){if(b.evs[d].pts&&1<b.evs[d].pts.t.length){var g;var f=b.evs[d];for(g=0;f.pts.t[g]<=e;)g+=1;2>g&&(g=2);g={cid:this.cacheFrame(f),pts:{t:f.pts.t.splice(0,g),x:f.pts.x.splice(0,g),y:f.pts.y.splice(0,g)}};var h=g.pts.x[g.pts.x.length-1],k=g.pts.y[g.pts.y.length-
1];f.pts.t.unshift(g.pts.t[g.pts.t.length-1]);f.pts.x.unshift(h);f.pts.y.unshift(k);f=g;a.evs.push(f)}(!b.evs[d].pts||b.evs[d].pts&&2>b.evs[d].pts.t.length)&&b.evs.splice(d,1)}c?this.framesHistory.push(a):this.newFrames.push(a)}},getCommandsHist:function(){return this.framesHistory},getCommandsCurrent:function(){var a=this.newFrames.splice(0,1),b;if(a.length){for(b=0;b<a.length;b+=1)this.framesHistory.push(a[b]);return a}return[]},undoSketch:function(a,b){function c(g,f,h){var k,l=g.length;for(--l;-1<
l;--l)if(!h&&g[l].uid===f||g[l].uid===f&&g[l].bid===h){var m=g.splice(l,1)[0];h=m.bid;for(k=0;k<m.evs.length;k+=1)void 0!==m.evs[k].cid&&Object.assign(m.evs[k],e.getCachedFrame(m.evs[k].cid));d.push(m)}}var d=[],e=this;c(this.newFrames,b,!1);c(this.framesHistory,b,!1);a.UID===b&&d.length&&(--this.userBFramesCounter,0===this.userBFramesCounter&&a.dispatch("undoUnavaliable"));return d},sendUndo:function(a){a.sendMessageToServer({sid:this.getId(),cmd:"undo",uid:a.UID,user:{user_id:a.UID}})},undo:function(a){a.sendInputs();
var b=this.undoSketch(a,a.UID);this.sendUndo(a);a.planRefreshWindow(0,"undo");this.myStash=this.myStash.concat(b);0<this.myStash.length&&a.dispatch("redoAvaliable")},redo:function(a){if(this.myStash&&0<this.myStash.length)if(this.myStash.length){var b=this.myStash.splice(-1)[0],c={sid:this.getId(),uid:a.UID,ts:(new Date).getTime(),cmd:"inputs",evs:b.evs};a.sendMessageToServer(c);this.grindBulkFrame(a,b);0===this.myStash.length&&a.dispatch("redoUnavaliable")}else console.warn("Redo stash empty!");
else a.dispatch("redoUnavaliable")},destructor:function(){this.reset()}});function Room(a,b){if(!(b instanceof Sketchpad))throw Error("Room(room_token, sketchpad)",a,"sketchpad must be instanceof Sketchpad.");this.sketchpad=b;this.room_token=a;this.sketches=[];this.prevSketch=[];this.totalCount=0;this.clients=[];b.room=this;return this}
Room.prototype={reset:function(){var a;for(a=this.sketches.length-1;0<=a;--a)this.sketches[a].destructor(),this.sketches.splice(a,1);this.sketch=void 0},getSketchBySid:function(a){var b;for(b=0;b<this.sketches.length;b+=1)if(this.sketches[b].getId()===a)return this.sketches[b];return!1},getSketchByNo:function(a){a=parseInt(a,10)-1;return this.sketches[a]},getCurrentSketchNo:function(){return this.sketches.indexOf(this.sketch)+1},addSketch:function(a,b){a.sendInputs();a.drawInputs();this.totalCount+=
1;if(!b)throw Error("Room.addSketch - config param is required");b=Object.assign({titleNo:this.totalCount},b);var c=new Sketch(b);this.sketches.push(c);a.dispatch("sketch-added",c);return c},setPageConfig:function(a,b){var c;b.sid&&(c=this.getSketchBySid(b.sid));c?(this.sketch===c&&this.sketch.setConfig(a.getSketchConfig()),c.setConfig(b),this.sketch===c&&a.setSketchConfig(c.getConfig()),a.dispatch("sketch-changed",c)):c=this.addSketch(a,b,"remoteFlag");this.sketch||this.setActiveSketch(a,c);return c},
setActiveSketch:function(a,b){b instanceof Sketch?(a.sendInputs(),a.drawInputs(),this.sketch&&(this.sketch.setConfig(a.getSketchConfig()),this.prevSketch.push(this.sketch)),this.sketch=b,a.setSketchConfig(b.getConfig()),a.dispatch("sketch-changed",b),a.dispatch("historySketch-status",b.getHistoryStatus()),a.planRefreshWindow(0,"room.js:setActiveSketch")):console.error("sketchpad.room.js","setActiveSketch(sketchpad, sketch) - sketch instanceof Sketch is required")},removeSketch:function(a,b,c){if(c||
a.canDraw()){if(!(b instanceof Sketch))throw Error("sketchpad.room.js:removeSketch(sketchpad, sketch, remoteRemoveFlag), sketch must be instanceof Sketch");a.sendInputs();a.drawInputs();var d;for(d=this.prevSketch.length-1;0<=d;--d)this.prevSketch[d]===b&&this.prevSketch.splice(d,1);for(d=this.sketches.length-1;0<=d;--d)this.sketches[d]===b&&this.sketches.splice(d,1);this.sketch===b&&(0<this.prevSketch.length?(this.sketch=this.prevSketch.pop(),a.setSketchConfig(this.sketch.getConfig()),a.dispatch("sketch-changed",
this.sketch)):0<this.sketches.length?(this.sketch=this.sketches[0],a.dispatch("sketch-changed",this.sketch),a.setSketchConfig(this.sketch.getConfig())):(this.sketch=null,a.setSketchConfig({})));a.dispatch("sketch-removed",b);c||a.sendMessageToServer({cmd:"remove-page",sid:b.getId()});a.planRefreshWindow(0,"room.js:removeSketch")}else console.error("Insufficient permissions to perform `removeSketch` operation")},addClient:function(a){"use strct";var b=a.user_color||{r:Math.round(25+205*Math.random()),
g:Math.round(25+205*Math.random()),b:Math.round(25+205*Math.random())},c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("div");e.style.display="none";e.style.backgroundColor="rgba("+b.r+", "+b.g+", "+b.b+", 0.5)";e.style.position="absolute";e.style.borderRadius="50%";e.style.marginLeft="-5px";e.style.marginTop="-5px";e.style.width="10px";e.style.height="10px";d.className="username";d.textContent="New ID: "+a.user_id;d.style.backgroundColor="rgba("+b.r+", "+
b.g+", "+b.b+", 1)";d.style.color="#FFF";d.style.fontSize="12px";c.appendChild(e);c.appendChild(d);c.className="viewport";c.style.position="absolute";c.style.overflow="hidden";c.style.border="1px solid rgba("+b.r+", "+b.g+", "+b.b+", 1)";c.style.boxSizing="border-box";a.pointerEl=e;a.usernameEl=d;a.viewportEl=c;this.setViewport(c,a,this.sketchpad);this.sketchpad.hudsEl.appendChild(a.viewportEl);this.clients.push(a);this.redrawViewports()},setViewportPointer:function(a,b,c){if(a=this.getClientById(a))a.pointerEl.style.display=
"block",a.pointerEl.style.left=b+"px",a.pointerEl.style.top=c+"px"},setViewport:function(a,b,c){if(this.sketch instanceof Sketch){var d=b.viewport;d.sid!==c.room.sketch.getId()?a.style.display="none":a.style.display="block";b.user_id===c.user.user_id&&(a.style.border="none",a.style.zIndex=2);a.querySelector(".username").textContent=(b.viewport.away?"[Away]":"")+" "+b.user_name;b.user_color&&void 0!==b.user_color.r&&(b.user_color_str="rgb("+b.user_color.r+","+b.user_color.g+","+b.user_color.b+")");
b.user_color_str&&(b.pointerEl.style.backgroundColor=b.user_color_str,b.usernameEl.style.backgroundColor=b.user_color_str,a.style.borderColor=b.user_color_str);a.style.top="0px";a.style.left="0px";a.style.width=d.width+"px";a.style.height=d.height+"px";a.style.transformOrigin=d.x+"px "+d.y+"px";a.style.webkitTransformOrigin=d.x+"px "+d.y+"px";a.style.MozTransformOrigin=d.x+"px "+d.y+"px";a.style.msTransformOrigin=d.x+"px "+d.y+"px";a.style.OTransformOrigin=d.x+"px "+d.y+"px";b="translate("+c.width/
2+"px,"+c.height/2+"px) scale("+1/d.scale+") rotate("+-1*d.rotation+"deg) translate("+d.x+"px, "+d.y+"px) translate("+-d.width/2+"px, "+-d.height/2+"px)";a.style.transform=b;a.style.webkitTransform=b;a.style.MozTransform=b;a.style.msTransform=b;a.style.OTransform=b}},redrawViewports:function(){var a=this;this.clients.forEach(function(b){a.setViewport(b.viewportEl,b,a.sketchpad)})},updateClient:function(a){var b;for(b=0;b<this.clients.length;b+=1){var c=this.clients[b];c.user_id===a.user_id&&Object.assign(c,
a)}this.redrawViewports()},getClientById:function(a){var b;for(b=this.clients.length-1;0<=b;--b){var c=this.clients[b];if(String(c.user_id)===String(a))return c}},removeClientById:function(a){console.warn("Removing user",a);var b;for(b=this.clients.length-1;0<=b;--b){var c=this.clients[b];String(c.user_id)===String(a)&&(this.sketchpad.hudsEl.removeChild(c.viewportEl),this.clients.splice(b,1))}}};
function Input(a){Input.prototype.instance+=1;this.timestamp=(new Date).getTime();this.type=a.type||"draw";this.uid=a.uid;this.id=a.id;this.layers=a.layers;this.tool=a.tool;this.font=a.font;this.color=a.color;this.fillColor=a.fillColor;this.size=a.size;this.center=a.center;this.listT=[];this.listX=[];this.listY=[];this.listP=[];this.prePoints=a.prePoints||[];this.lastP=this.lastY=this.lastX=this.lastT=NaN;this.lastDrawPointer=this.lastSendPointer=0;this.sketchpad=a.sketchpad;this.viewportX=this.sketchpad.viewportX;
this.viewportY=this.sketchpad.viewportY;this.scale=this.sketchpad.scale;this.rotation=this.sketchpad.rotation;this.width=this.sketchpad.width;this.height=this.sketchpad.height;this.UID=this.sketchpad.UID;this.url=a.url;return this}
Input.prototype={instance:0,getConfig:function(){return{lay:this.layers.slice(),siz:this.size,col:this.color,fcl:this.fillColor,txt:this.textContent,fnt:this.font,axs:this.axis,tst:1,url:this.url,cen:this.center,mrh:this.mirrorH,mrv:this.mirrorV,mvh:this.mirrorVH,rbw:this.rainbow}},addPoint:function(a,b,c,d){this.sketchpad.readOnly||b===this.lastX&&c===this.lastY&&!d||(this.lastT=a-this.timestamp,this.lastX=b,this.lastY=c,this.listT.push(a-this.timestamp),this.listX.push(b),this.listY.push(c))},getLastPoint:function(){return this.listX.length?
{x:this.listX[this.listX.length-1],y:this.listY[this.listY.length-1]}:!1},getPointsToSend:function(){var a;if(this.lastSendPointer<this.listX.length-1){var b=this.listT[this.lastSendPointer],c=this.listT.slice(this.lastSendPointer),d=this.listX.slice(this.lastSendPointer),e=this.listY.slice(this.lastSendPointer);this.lastSendPointer=this.listX.length-1;for(a=0;a<c.length;a+=1)c[a]-=b;return{t:c,x:d,y:e}}},getPointsToDraw:function(){if(this.lastDrawPointer<this.listX.length-1){var a=this.listX.slice(this.lastDrawPointer),
b=this.listY.slice(this.lastDrawPointer),c=this.listT.slice(this.lastDrawPointer);this.lastDrawPointer=this.listX.length-1;return{t:c,x:a,y:b}}},getPoints:function(){var a=[],b=this;this.listT.forEach(function(c,d){a.push({t:c,x:b.listX[d],y:b.listY[d]})});return a},setPoints:function(a){this.listT=[];this.listX=[];this.listY=[];var b=this;a.forEach(function(c){b.listT.push(c.t);b.listX.push(c.x);b.listY.push(c.y)});console.info("setPoints",a)}};
function Tool(a){Eventsmanager.call(this,a);if(!a)return this;if(!(a.sketchpad instanceof Sketchpad))throw console.warn("config.sketchpad must be instanceof Sketchpad"),Error("config.sketchpad must be instanceof Sketchpad");this.sketchpad=a.sketchpad;a.toolId&&(this.toolId=a.toolId);a.lineWidth&&(this.lineWidth=a.lineWidth);a.layers&&(this.layers=a.layers);a.color&&(this.color=a.color)}Tool.prototype=Object.create(Eventsmanager.prototype);
Tool.prototype=Object.assign(Tool.prototype,{sketchpad:"error: undefined sketchpad object",layers:["F"],toolLabel:"Default tool",toolId:"default_tool_class",lineWidth:1,minSize:.1,maxSize:100,maxLayers:1,color:{r:0,g:0,b:0,a:1},getCursor:function(){var a=parseInt(this.getSize()+1,10);return{pointer:this.pointer||"unset",marginLeft:-a/2+"px",marginTop:-a/2+"px",width:a+"px",height:a+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getToolConfig:function(){return{toolId:this.toolId,
layers:this.layers,lineWidth:this.lineWidth,maxLayers:this.maxLayers,color:this.getColorStr()}},setToolConfig:function(a){Array.isArray(a.layers)&&(this.layers=a.layers);if(a.color)switch(typeof a.color){case "string":var b=String(a.color).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/);var c=parseInt(b&&b[1])||0;var d=parseInt(b&&b[2])||0;var e=parseInt(b&&b[3])||0;b=parseFloat(b&&b[4])||0;this.setColor(c,d,e,b);break;case "object":this.setColor(a.color.r,a.color.g,a.color.b,a.color.a)}parseFloat(a.lineWidth)&&
this.setSize(parseFloat(a.lineWidth));this.dispatch("changeParams");return this},distance:function(a,b,c,d){return Math.sqrt(Math.pow(Math.abs(a-c),2)+Math.pow(Math.abs(b-d),2))},rotate:function(a,b){a=a/360*Math.PI*2;return b={x:Math.cos(a)*b.x-Math.sin(a)*b.y,y:Math.sin(a)*b.x+Math.cos(a)*b.y,t:b.t}},setColor:function(a,b,c,d){void 0===d&&(d=this.color.a);this.color={r:a,g:b,b:c,a:d};this.dispatch("changeParams");return this},getColor:function(){return this.color},getColorStr:function(){return"rgba("+
this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},setSize:function(a){this.lineWidth=parseFloat(a);this.dispatch("changeParams");return this},getSize:function(){return this.lineWidth},startInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));a=new Input({sketchpad:this.sketchpad,id:a,tool:this.toolId,layers:this.layers,color:this.getColorStr(),size:this.lineWidth});a.addPoint((new Date).getTime(),b,c);a.addPoint((new Date).getTime(),b,c,"force");return a},
moveInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));if(d&&d.shiftKey){var e=a.getLastPoint();if(e&&(10>Math.abs(e.x-b)&&(b=e.x),10>Math.abs(e.y-c)&&(c=e.y),e.x===b&&e.y===c))return!1}a.addPoint((new Date).getTime(),b,c,d)},finishInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));a.addPoint((new Date).getTime(),b,c)},drawFramePath:function(a,b){var c=this.sketchpad,d,e,g=a.cnf;if(g.lay&&g.lay.length)for(e=0;e<g.lay.length;e+=1){switch(g.lay[e]){case c.LAYER_BACK:var f=
c.contextB2D;break;case c.LAYER_FRONT:f=c.context2D;break;default:f=c.context2D}f.save();f.rotate(c.rotation*Math.PI/180);f.scale(c.scale,c.scale);f.translate(a.vpx,a.vpy);f.translate(-c.viewportX,-c.viewportY);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*Math.PI/180);if(b&&b.x&&1<b.x.length){f.beginPath();f.lineCap="round";f.lineJoin="round";f.strokeStyle=g.col;f.lineWidth=g.siz;f.moveTo(b.x[0],b.y[0]);for(d=1;d<b.x.length;d+=1)f.lineTo(b.x[d],b.y[d]);f.stroke()}f.restore()}else console.warn("no layers to draw")}});
NSSketchpad.avaliableTools.push(Tool);function ToolFillable(a){Tool.call(this,a)}ToolFillable.prototype=Object.create(Tool.prototype);
Object.assign(ToolFillable.prototype,{toolLabel:"_fillable class",toolId:"_fillable class",fillColor:{r:128,g:0,b:128,a:.1},getToolConfig:function(){var a=Tool.prototype.getToolConfig.call(this);return Object.assign(a,{fillColor:this.getFillColorStr()})},setToolConfig:function(a){Tool.prototype.setToolConfig.call(this,a);if(a.fillColor)switch(typeof a.fillColor){case "string":var b=String(a.fillColor).match(/([0-9]+),([0-9]+),([0-9]+),([0-9\.]+)/);a=parseInt(b&&b[1])||0;var c=parseInt(b&&b[2])||0;
var d=parseInt(b&&b[3])||0;b=parseFloat(b&&b[4])||0;this.setFillColor(a,c,d,b);break;case "object":this.setFillColor(a.fillColor.r,a.fillColor.g,a.fillColor.b,a.fillColor.a)}this.dispatch("changeParams");return this},setFillColor:function(a,b,c,d){void 0===d&&(d=this.fillColor.a);this.fillColor={r:a,g:b,b:c,a:d};this.dispatch("changeParams");return this},getFillColor:function(){return this.fillColor},getFillColorStr:function(){return"rgba("+this.fillColor.r+","+this.fillColor.g+","+this.fillColor.b+
","+this.fillColor.a+")"}});function ToolAipen(a){ToolFillable.call(this,a)}ToolAipen.prototype=Object.create(ToolFillable.prototype);
Object.assign(ToolAipen.prototype,{color:{r:0,g:0,b:0,a:1},fillColor:{r:255,g:127,b:0,a:0},lineWidth:1,layers:["F"],keyCode:65,toolId:"aipen",toolLabel:"AI Pen",smoothLength:16,smoothFactor:.2,minDist:0,minTime:0,cursor:"pointer",closedFigureDistance:20,MAX_PERCENT_ERROR:.01,connect:function(a,b,c,d,e,g){var f=Math.sqrt((d-b)*(d-b)+(e-c)*(e-c)),h=(b+d)/2-f/2;g=(c+e)/2-g/2;b=180/Math.PI*Math.atan2(c-e,b-d);this.sketchpad.centerViewport?(a.style.left=this.sketchpad.width/2+h+"px",a.style.top=this.sketchpad.height/
2+g+"px"):(a.style.left=h+"px",a.style.top=g+"px");a.style.width=f+"px";a.style.transform="rotate("+b+"deg)";a.style.webkitTransform="rotate("+b+"deg)";a.style.MozTransform="rotate("+b+"deg)";a.style.msTransform="rotate("+b+"deg)";a.style.OTransform="rotate("+b+"deg)"},smooth:function(a){var b=this.smoothFactor;if(!(2>a.length)){var c=a.length-this.smoothLength;for(1>c&&(c=1);c<a.length;c+=1){var d=a[c];var e=a[c-1];d={x:d.x*(1-b)+e.x*b,y:d.y*(1-b)+e.y*b,t:d.t};a[c]=d}}},drawProjector:function(a){var b=
a.viewportX,c=a.viewportY,d=a.scale,e=a.rotation,g=this.sketchpad,f=a.prePoints;if(!(2>f.length)){a.marker||g.clearProjector();var h=g.contextProjector2D;h.save();h.rotate(g.rotation*Math.PI/180);h.scale(g.scale,g.scale);h.translate(b,c);h.translate(-g.viewportX,-g.viewportY);h.scale(1/d,1/d);h.rotate(-e*Math.PI/180);b=f[0];h.beginPath();h.strokeStyle=a.color||this.getColorStr();h.lineCap="miter";h.lineJoin="miter";h.moveTo(b.x,b.y);for(i=1;i<f.length;i+=1)b=f[i-1],c=f[i],this.distance(b.x,b.y,c.x,
c.y),h.lineWidth=a.size,h.lineTo(c.x,c.y);h.stroke();h.restore()}},startInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers,prePoints:[]});a.selectorDiv=document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.display="none";a.selectorDiv.style.backgroundColor=this.getColorStr();
this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";var e=this.getSize();1>e&&(a.selectorDiv.style.borderTop="1px dashed "+this.getColorStr());a.selectorDiv.style.height=e+"px";e=(new Date).getTime();a.startX=b;a.startY=c;a.startT=e;a.lastX=b;a.lastY=c;a.lastT=e;d.containerEl.appendChild(a.selectorDiv);a.prePoints.push({t:e,
x:b,y:c});this.drawProjector(a);return a},moveInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));if(d&&d.shiftKey&&(d=a.getLastPoint())&&(10>Math.abs(d.x-b)&&(b=d.x),10>Math.abs(d.y-c)&&(c=d.y),d.x===b&&d.y===c))return!1;d=(new Date).getTime();a.lastT=d;a.lastX=b;a.lastY=c;a.prePoints.push({t:d,x:b,y:c});this.smooth(a.prePoints);this.connect(a.selectorDiv,a.prePoints[0].x,a.prePoints[0].y,b,c,this.getSize());this.drawProjector(a)},finishInput:function(a,b,c,d){d.altKey&&
(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=this.sketchpad,g=a.startX,f=a.startY;if(d.shiftKey){d=b-g;var h=c-f;c=this.distance(g,f,b,c);d=Math.PI/4*Math.round(Math.atan2(d,h)/(Math.PI/4));b=g+c*Math.sin(d);c=f+c*Math.cos(d)}g=(new Date).getTime();a.prePoints.push({t:g,x:b,y:c});this.smooth(a.prePoints);e.containerEl.removeChild(a.selectorDiv);this.drawProjector(a);this.updateBestFigure(a);a.prePoints.forEach(function(k){a.addPoint(k.t,k.x,k.y)});e.clearProjector()},rotateInput:function(a,
b){var c=this;return a=a.map(function(d){return c.rotate(b,d)})},getBoundingInputRect:function(a){var b,c={maxX:-Infinity,maxY:-Infinity,minX:Infinity,minY:Infinity,width:0,height:0,centeredInput:JSON.parse(JSON.stringify(a))},d={x:0,y:0,t:0};for(b=0;b<a.length;b+=1){var e=a[b];d.x+=e.x;d.y+=e.y;d.t+=e.t;c.maxX<e.x&&(c.maxX=e.x,c.pointLeft=e);c.maxY<e.y&&(c.maxY=e.y,c.pointBottom=e);c.minX>e.x&&(c.minX=e.x,c.pointRight=e);c.minY>e.y&&(c.minY=e.y,c.pointTop=e)}d.x/=a.length;d.y/=a.length;d.t/=a.length;
c.pointsWage=d;c.width=c.maxX-c.minX;c.height=c.maxY-c.minY;c.longestEdge=c.width>c.height?c.width:c.height;c.avgEdge=c.width*c.height;c.centerX=c.minX+c.width/2;c.centerY=c.minY+c.height/2;for(b=0;b<c.centeredInput.length;b+=1)e=c.centeredInput[b],e.x-=c.centerX,e.y-=c.centerY,e.distanceFromCenter=this.distance(0,0,e.x,e.y);c.area=c.width*c.height;c.cMinX=c.centerX-c.width/2;c.cMaxX=c.centerX+c.width/2;c.cMinY=c.centerY-c.height/2;c.cMaxY=c.centerY+c.height/2;c.firstPoint=c.centeredInput[0];c.lastPoint=
c.centeredInput[c.centeredInput.length-1];return c},updateBestFigure:function(a){var b=JSON.parse(JSON.stringify(a.prePoints)),c=this;b=this.getBoundingInputRect(b);var d;var e=b.centeredInput.reduce(function(l,m,n,p){if(d)return l+=c.distance(d.x,d.y,m.x,m.y),d=m,l;d=m;return l},0);var g=b.firstPoint,f=b.lastPoint;g=this.distance(g.x,g.y,f.x,f.y);var h={angle:[],maxWidth:0,maxHeight:0,minRectArea:0,horizontal:void 0,vertical:void 0,optimal:void 0,lineDistance:e};for(e=0;360>e;e+=1){f=this.getBoundingInputRect(this.rotateInput(b.centeredInput,
e));f.rotation=e;h.angle[e]=f;if(void 0===h.optimal||f.area<=h.optimal.area)h.optimal&&h.optimal.area===f.area&&h.optimal.width===f.width&&console.log("bingo"),h.minRectArea=f.area,h.optimal=f;if(void 0===h.horizontal||h.maxWidth<f.width)h.maxWidth=f.width,h.horizontal=f;if(void 0===h.vertical||h.maxHeight<f.height)h.maxHeight=f.height,h.vertical=f}h.firstLastDistance=g;h.isClosed=g<Math.sqrt(h.maxWidth*h.maxWidth*.05);console.log("%cPROJECTIONS","color:white;background:red",h,b,h.isClosed);c=this;
var k=[];["detectEllipse","detectRectangle","detectTriangle"].forEach(function(l){h.angle.forEach(function(m){(detection=c[l](h,m,a))&&k.push(detection)})});k.length&&(k.sort(function(l,m){return l.missmatch-m.missmatch}),console.groupCollapsed("Detections ["+k[0].detector+"] "+k[0].missmatch),k.forEach(function(l){console.log("%c"+l.detector,"background:darkblue;color:white",l.missmatch)}),console.groupEnd(),(e=k[0])&&.05>e.missmatch&&(setTimeout(function(){},100),console.log("%cbest detection",
"background:darkgreen;color:white",e),a.viewportX+=(b.centerX+e.boundingInputRect.centerX)/a.scale,a.viewportY+=(b.centerY+e.boundingInputRect.centerY)/a.scale,a.tool=e.tool,a.rotation=e.boundingInputRect.rotation,a.prePoints=e.prePoints))},getDistanceFromLine:function(a,b,c){var d=b.x-a.x,e=b.y-a.y,g=(d*(c.x-a.x)+e*(c.y-a.y))/(Math.pow(d,2)+Math.pow(e,2));a=0>=g?a:1<=g?b:{x:a.x+g*d,y:a.y+g*e};return Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2))},getDistanceFromLine3:function(a,b,c){var d=this.distance(a.x,
a.y,b.x,b.y);if(0===d)return this.distance(c.x,c.y,a.x,a.y);d=((c.x-a.x)*(b.x-a.x)+(c.y-a.y)*(b.y-a.y))/d;d=Math.max(0,Math.min(1,d));return this.distance(c.x,c.y,a.x+d*(b.x-a.x),a.y+d*(b.y-a.y))},getDistanceFromLine2:function(a,b,c){var d=a.x,e=a.y,g=b.x;y2=b.y;var f=1;g-d?(e=(y2-e)/(g-d),d=y2-e*g):(e=1,f=0,d=-d);console.log("y = ("+e+") * x + ("+d+")");g=-e;0===g&&0===f&&console.error("A and B equals 0");d=-d;console.log("("+g+") * x + ("+f+") * y + ("+d+") = 0");f=Math.abs(g*c.x+f*c.y+d)/Math.sqrt(g*
g+f*f);console.log("get distance of ",c," from line between ",a,b," is ",f);return f},detectLine:function(a,b){var c,d=!0,e=0;a.isClosed&&(d=!1);for(c=0;c<b.centeredInput.length;c+=1){point=b.centeredInput[c];var g=this.getDistanceFromLine({x:b.cMinX,y:0},{x:b.cMaxX,y:0},point);e+=g}c=b.width;c=Math.abs(a.lineDistance-c)/c;e=e/b.centeredInput.length/b.avgEdge;if(d)return d=[],d.push({x:b.firstPoint.x,y:b.firstPoint.y,t:Date.now()+0}),d.push({x:b.lastPoint.x,y:b.lastPoint.y,t:Date.now()+1}),{boundingInputRect:b,
detector:"line",perimeterMissmatch:c,distanceMissmatch:e,missmatch:e,prePoints:d,tool:"line"}},detectTriangle:function(a,b){var c,d=!0;a.isClosed||(d=!1);var e=b.centeredInput,g=0,f=b.pointLeft,h=b.pointRight,k=b.pointTop,l=this.distance(f.x,f.y,h.x,h.y)+this.distance(h.x,h.y,k.x,k.y)+this.distance(k.x,k.y,f.x,f.y);if(l){for(c=0;c<e.length;c+=1)point=e[c],missmatch=Math.min(this.getDistanceFromLine(f,h,point),this.getDistanceFromLine(h,k,point),this.getDistanceFromLine(k,f,point)),g+=missmatch;c=
Math.abs(a.lineDistance-l)/l;e=g/e.length/b.avgEdge;if(d)return d=[],d.push({x:f.x,y:f.y,t:Date.now()+0}),d.push({x:h.x,y:h.y,t:Date.now()+1}),d.push({x:k.x,y:k.y,t:Date.now()+2}),d.push({x:f.x,y:f.y,t:Date.now()+2}),{boundingInputRect:b,detector:"triangle",perimeterMissmatch:c,distanceMissmatch:e,missmatch:e,prePoints:d,tool:"pen"}}},detectRectangle:function(a,b){var c,d=!0;a.isClosed||(d=!1);var e=b.centeredInput,g=0;for(c=0;c<e.length;c+=1){point=e[c];var f={x:b.cMinX,y:b.cMinY},h={x:b.cMaxX,y:b.cMinY},
k={x:b.cMaxX,y:b.cMaxY},l={x:b.cMinX,y:b.cMaxY},m=this.getDistanceFromLine(f,h,point),n=this.getDistanceFromLine(h,k,point),p=this.getDistanceFromLine(k,l,point),r=this.getDistanceFromLine(l,f,point);missmatch=Math.min(m,n,p,r);g+=missmatch}if(c=2*b.width+2*b.height)if(c=Math.abs(a.lineDistance-c)/c,e=g/e.length/b.avgEdge,d)return d=[],d.push({x:f.x,y:f.y,t:Date.now()-4}),d.push({x:h.x,y:h.y,t:Date.now()-3}),d.push({x:k.x,y:k.y,t:Date.now()-2}),d.push({x:l.x,y:l.y,t:Date.now()-1}),d.push({x:f.x,y:f.y,
t:Date.now()-0}),{boundingInputRect:b,detector:"rectangle",perimeterMissmatch:c,distanceMissmatch:e,missmatch:e,fillColor:this.getFillColorStr(),prePoints:d,tool:"pen"}},getEllipsePt:function(a,b,c,d,e,g){var f=Math.PI/2;var h=e>a?g>b?0:3:g>b?1:2;var k=(h+1)*f,l=f/360,m=Infinity;for(f*=h;f<k;f+=l){h=a+c*Math.cos(f);var n=b+d*Math.sin(f),p=e-h,r=g-n;p=p*p+r*r;if(p<m){var q=h;var t=n;m=p}}return{x:q,y:t}},ellipsePerimeter:function(a,b){return Math.PI*(3*(a+b)-Math.sqrt((3*a+b)*(a+3*b)))},detectEllipse:function(a,
b){var c,d=!0;a.isClosed||(d=!1);var e=b.centeredInput,g=0;for(c=0;c<e.length;c+=1){var f=e[c];closestPointOnEllipse=this.getEllipsePt(0,0,b.width/2,b.height/2,f.x,f.y);missmatch=this.distance(f.x,f.y,closestPointOnEllipse.x,closestPointOnEllipse.y);g+=missmatch}if(c=this.ellipsePerimeter(b.width/2,b.height/2))if(c=Math.abs(a.lineDistance-c)/c,e=g/e.length/b.avgEdge,d)return d=[],d.push({x:b.centerX,y:b.centerY,t:Date.now()}),d.push({x:b.width/2,y:b.height/2,t:Date.now()}),{boundingInputRect:b,detector:"ellipse",
perimeterMissmatch:c,distanceMissmatch:e,missmatch:e,fillColor:"blue",prePoints:d,tool:"circle"}},detectCircle:function(a,b){var c,d=!0;a.isClosed||(d=!1);var e=Infinity,g=-Infinity,f=b.centeredInput,h=0;f.forEach(function(n){h+=n.distanceFromCenter});var k=h/f.length,l=0;for(c=0;c<f.length;c+=1){var m=f[c];m=m.distanceFromCenter;e>m&&(e=m);g<m&&(g=m);l+=m}c=l/f.length;c>Math.sqrt(b.width*b.height)&&(d=!1);.1<Math.abs(c-k)&&(d=!1);console.log("%cisCircle [%c"+d+"]","background:black;color:white",
"background:black;color:white","P:",0,"L:",a.lineDistance,"E:",0);if(d)return d=[],d.push({x:b.centerX,y:b.centerY,t:Date.now()}),d.push({x:b.centerX+k,y:b.centerY+k,t:Date.now()}),{boundingInputRect:b,detector:"circle",missmatch:l/f.length,fillColor:this.getFillColorStr(),prePoints:d,tool:"circle"}},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e,g;if(c.lay&&c.lay.length)for(g=0;g<c.lay.length;g+=1){switch(c.lay[g]){case d.LAYER_BACK:var f=d.contextB2D;break;case d.LAYER_FRONT:f=d.context2D;
break;default:f=d.context2D}f.save();f.rotate(d.rotation*Math.PI/180);f.scale(d.scale,d.scale);f.translate(-d.viewportX,-d.viewportY);f.translate(a.vpx,a.vpy);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*Math.PI/180);if(b&&b.x&&b.y&&1<b.x.length){var h=b.x[0];var k=b.y[0];f.beginPath();f.strokeStyle=c.col;f.lineCap="miter";f.lineJoin="miter";f.lineWidth=c.siz;f.moveTo(h,k);for(e=1;e<b.x.length;e+=1)h=b.x[e],k=b.y[e],f.lineTo(h,k);f.stroke()}f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolAipen);
function hexToRgbA(a){console.log(a);if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(a))return a=a.substring(1).split(""),3==a.length&&(a=[a[0],a[0],a[1],a[1],a[2],a[2]]),a="0x"+a.join(""),{r:a>>16&255,g:a>>8&255,b:a&255,a:1};throw Error("Bad Hex");}function ToolCirc(a){ToolFillable.call(this,a)}console.log("rgba?",hexToRgbA(setPallete_HEX.value));ToolCirc.prototype=Object.create(ToolFillable.prototype);
Object.assign(ToolCirc.prototype,{lineWidth:1,toolLabel:"Circle",layers:["F"],toolId:"circle",keyCode:67,color:hexToRgbA(setPallete_HEX.value),fillColor:hexToRgbA(setPallete_HEX_border.value),startInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers,uid:this.sketchpad.UID});a.firstX=b;a.firstY=c;a.selectorDiv=
document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.border="1px solid white";a.selectorDiv.style.borderRadius="50%";a.selectorDiv.style.display="block";this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b-1+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c-1+"px"):(a.selectorDiv.style.left=b-1+"px",a.selectorDiv.style.top=c-1+"px");a.selectorDiv.style.width="1px";a.selectorDiv.style.height="1px";a.selectorDiv2=document.createElement("div");
a.selectorDiv2.style.position="absolute";a.selectorDiv2.style.border="1px dashed black";a.selectorDiv2.style.borderRadius="50%";a.selectorDiv2.style.display="block";this.sketchpad.centerViewport?(a.selectorDiv2.style.left=this.sketchpad.width/2+b-1+"px",a.selectorDiv2.style.top=this.sketchpad.height/2+c-1+"px"):(a.selectorDiv2.style.left=b-1+"px",a.selectorDiv2.style.top=c-1+"px");a.selectorDiv2.style.width="1px";a.selectorDiv2.style.height="1px";d.containerEl.appendChild(a.selectorDiv);d.containerEl.appendChild(a.selectorDiv2);
a.addPoint((new Date).getTime(),b,c);return a},moveInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=a.firstX,g=a.firstY;b=Math.abs(b-e);c=Math.abs(c-g);d.shiftKey&&(b=c);this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+e-b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+g-c+"px",a.selectorDiv2.style.left=this.sketchpad.width/2+e-b+"px",a.selectorDiv2.style.top=this.sketchpad.height/2+g-c+"px"):(a.selectorDiv.style.left=e-b+
"px",a.selectorDiv.style.top=g-c+"px",a.selectorDiv2.style.left=e-b+"px",a.selectorDiv2.style.top=g-c+"px");a.selectorDiv.style.width=2*b+"px";a.selectorDiv.style.height=2*c+"px";a.selectorDiv2.style.width=2*b+"px";a.selectorDiv2.style.height=2*c+"px"},finishInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=this.sketchpad,g=a.firstX,f=Math.abs(c-a.firstY);d.shiftKey&&(b=g+f);a.addPoint((new Date).getTime(),b,c);e.containerEl.removeChild(a.selectorDiv);e.containerEl.removeChild(a.selectorDiv2)},
recalcS:function(a,b){var c=this.sketchpad;b*=1/a.scl;return b*=c.scale},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e;if(c.lay&&c.lay.length)for(e=0;e<c.lay.length;e+=1){switch(c.lay[e]){case d.LAYER_BACK:var g=d.contextB2D;break;case d.LAYER_FRONT:g=d.context2D;break;default:g=d.context2D}g.save();g.rotate(d.rotation*Math.PI/180);g.scale(d.scale,d.scale);g.translate(-d.viewportX,-d.viewportY);g.translate(a.vpx,a.vpy);g.scale(1/a.scl,1/a.scl);g.rotate(-a.rot*Math.PI/180);var f=b.x[0];
var h=b.y[0];var k=b.x[1];var l=b.y[1];g.translate(f,h);g.beginPath();g.scale(1,Math.abs(l-h)/Math.abs(k-f));k=Math.abs(k-f);g.arc(0,0,k,0,2*Math.PI,!1);g.restore();g.strokeStyle=c.col;g.fillStyle=c.fcl;g.lineWidth=this.recalcS(a,c.siz);g.fill();g.stroke();g.restore()}else console.warn("no layers to draw")}});
setPallete_HEX.addEventListener("change",function(a){Object.assign(ToolCirc.prototype,{lineWidth:1,toolLabel:"Circle",layers:["F"],toolId:"circle",keyCode:67,color:hexToRgbA(setPallete_HEX.value),fillColor:hexToRgbA(setPallete_HEX.value),startInput:function(b,c,d,e){e&&e.altKey&&(c=10*Math.round(c/10),d=10*Math.round(d/10));e=this.sketchpad;b=new Input({sketchpad:e,id:b,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers,uid:this.sketchpad.UID});
b.firstX=c;b.firstY=d;b.selectorDiv=document.createElement("div");b.selectorDiv.style.position="absolute";b.selectorDiv.style.border="1px solid white";b.selectorDiv.style.borderRadius="50%";b.selectorDiv.style.display="block";this.sketchpad.centerViewport?(b.selectorDiv.style.left=this.sketchpad.width/2+c-1+"px",b.selectorDiv.style.top=this.sketchpad.height/2+d-1+"px"):(b.selectorDiv.style.left=c-1+"px",b.selectorDiv.style.top=d-1+"px");b.selectorDiv.style.width="1px";b.selectorDiv.style.height="1px";
b.selectorDiv2=document.createElement("div");b.selectorDiv2.style.position="absolute";b.selectorDiv2.style.border="1px dashed black";b.selectorDiv2.style.borderRadius="50%";b.selectorDiv2.style.display="block";this.sketchpad.centerViewport?(b.selectorDiv2.style.left=this.sketchpad.width/2+c-1+"px",b.selectorDiv2.style.top=this.sketchpad.height/2+d-1+"px"):(b.selectorDiv2.style.left=c-1+"px",b.selectorDiv2.style.top=d-1+"px");b.selectorDiv2.style.width="1px";b.selectorDiv2.style.height="1px";e.containerEl.appendChild(b.selectorDiv);
e.containerEl.appendChild(b.selectorDiv2);b.addPoint((new Date).getTime(),c,d);return b},moveInput:function(b,c,d,e){e&&e.altKey&&(c=10*Math.round(c/10),d=10*Math.round(d/10));var g=b.firstX,f=b.firstY;c=Math.abs(c-g);d=Math.abs(d-f);e.shiftKey&&(c=d);this.sketchpad.centerViewport?(b.selectorDiv.style.left=this.sketchpad.width/2+g-c+"px",b.selectorDiv.style.top=this.sketchpad.height/2+f-d+"px",b.selectorDiv2.style.left=this.sketchpad.width/2+g-c+"px",b.selectorDiv2.style.top=this.sketchpad.height/
2+f-d+"px"):(b.selectorDiv.style.left=g-c+"px",b.selectorDiv.style.top=f-d+"px",b.selectorDiv2.style.left=g-c+"px",b.selectorDiv2.style.top=f-d+"px");b.selectorDiv.style.width=2*c+"px";b.selectorDiv.style.height=2*d+"px";b.selectorDiv2.style.width=2*c+"px";b.selectorDiv2.style.height=2*d+"px"},finishInput:function(b,c,d,e){e&&e.altKey&&(c=10*Math.round(c/10),d=10*Math.round(d/10));var g=this.sketchpad,f=b.firstX,h=Math.abs(d-b.firstY);e.shiftKey&&(c=f+h);b.addPoint((new Date).getTime(),c,d);g.containerEl.removeChild(b.selectorDiv);
g.containerEl.removeChild(b.selectorDiv2)},recalcS:function(b,c){var d=this.sketchpad;c*=1/b.scl;return c*=d.scale},drawFramePath:function(b,c){var d=b.cnf,e=this.sketchpad,g;if(d.lay&&d.lay.length)for(g=0;g<d.lay.length;g+=1){switch(d.lay[g]){case e.LAYER_BACK:var f=e.contextB2D;break;case e.LAYER_FRONT:f=e.context2D;break;default:f=e.context2D}f.save();f.rotate(e.rotation*Math.PI/180);f.scale(e.scale,e.scale);f.translate(-e.viewportX,-e.viewportY);f.translate(b.vpx,b.vpy);f.scale(1/b.scl,1/b.scl);
f.rotate(-b.rot*Math.PI/180);var h=c.x[0];var k=c.y[0];var l=c.x[1];var m=c.y[1];f.translate(h,k);f.beginPath();f.scale(1,Math.abs(m-k)/Math.abs(l-h));l=Math.abs(l-h);f.arc(0,0,l,0,2*Math.PI,!1);f.restore();f.strokeStyle=d.col;f.fillStyle=d.fcl;f.lineWidth=this.recalcS(b,d.siz);f.fill();f.stroke();f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolCirc)});NSSketchpad.avaliableTools.push(ToolCirc);
function ToolColorpicker(a){ToolFillable.call(this,a);this.toolId=a.toolId||"colorpicker";this.layers=[]}ToolColorpicker.prototype=Object.create(ToolFillable.prototype);
Object.assign(ToolColorpicker.prototype,{maxLayers:0,keyCode:73,toolLabel:"Colorpicker",toolId:"colorpicker",color:{r:128,g:128,b:128,a:0},getCursor:function(){return{pointer:"none",marginLeft:"-5px",marginTop:"-5px",width:"10px",height:"10px",borderRadius:"50%",border:"1px solid black",backgroundColor:this.getColorStr()}},startInput:function(a,b,c,d){var e=this.sketchpad;a=new Input({sketchpad:e,id:a,tool:this.toolId});b=this.sketchpad.colorPicker(b,c);d.shiftKey||2===d.button?(this.fillColorChanged=
!0,this.setFillColor(b.r,b.g,b.b,b.a)):(this.colorChanged=!0,this.setColor(b.r,b.g,b.b,b.a));a.tmpCursor=this.sketchpad.containerEl.style.cursor;e.containerEl.style.cursor="crosshair";return a},moveInput:function(a,b,c,d){b=this.sketchpad.colorPicker(b,c);2===d.button&&(d.preventDefault(),d.stopPropagation());d.shiftKey||2===d.button?(this.fillColorChanged=!0,this.setFillColor(b.r,b.g,b.b,b.a)):(this.colorChanged=!0,this.setColor(b.r,b.g,b.b,b.a));return a},finishInput:function(a,b,c,d){b=this.sketchpad.colorPicker(b,
c);2===d.button&&(d.preventDefault(),d.stopPropagation());d.shiftKey||2===d.button?(this.fillColorChanged=!0,this.setFillColor(b.r,b.g,b.b,b.a)):(this.colorChanged=!0,this.setColor(b.r,b.g,b.b,b.a));this.sketchpad.containerEl.style.cursor=a.tmpCursor;return a},drawFramePath:function(){}});NSSketchpad.avaliableTools.push(ToolColorpicker);function ToolCustom(a){Tool.call(this,a)}ToolCustom.prototype=Object.create(Tool.prototype);
Object.assign(ToolCustom.prototype,{toolId:"custom",lineWidth:10,keyCode:88,toolLabel:"Custom tool",drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e,g;if(c.lay&&c.lay.length)for(g=0;g<c.lay.length;g+=1){switch(c.lay[g]){case d.LAYER_BACK:var f=d.contextB2D;break;case d.LAYER_FRONT:f=d.context2D;break;default:f=d.context2D}f.save();f.rotate(d.rotation*Math.PI/180);f.scale(d.scale,d.scale);f.translate(a.vpx,a.vpy);f.translate(-d.viewportX,-d.viewportY);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*
Math.PI/180);if(b&&b.x&&b.y&&1<b.x.length)for(e=1;e<b.x.length;e+=1){var h=b.x[e-1];var k=b.y[e-1];var l=b.x[e];var m=b.y[e];f.beginPath();f.strokeStyle=this.getColorStr();f.lineCap="miter";f.lineJoin="miter";f.lineWidth=c.siz+100/(10+this.distance(h,k,l,m));f.moveTo(h,k);f.lineTo(l,m);f.stroke()}f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolCustom);function ToolCutout(a){Tool.call(this,a);this.toolId=a.toolId||"cutout"}ToolCutout.prototype=Object.create(Tool.prototype);
Object.assign(ToolCutout.prototype,{maxLayers:"*",toolId:"cutout",layers:["F","B"],toolLabel:"Cut-out",getCursor:function(){return{pointer:"crosshair",borderRadius:0,backgroundColor:"rgba(0,0,0,0)",border:"none"}},startInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,layers:this.layers});a.selectorDiv=document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.border="1px solid #f00";
a.selectorDiv.style.display="block";this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";a.selectorDiv.style.height="1px";a.selectorDiv.style.background="#f88";a.selectorDiv.style.opacity="0.3";d.containerEl.appendChild(a.selectorDiv);a.addPoint((new Date).getTime(),b,c);return a},moveInput:function(a,b,c,d){d&&d.altKey&&
(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=a.listX[0],g=a.listY[0];d=Math.min(e,b);var f=Math.min(g,c);b=Math.max(e,b);c=Math.max(g,c);this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+d+"px",a.selectorDiv.style.top=this.sketchpad.height/2+f+"px"):(a.selectorDiv.style.left=d+"px",a.selectorDiv.style.top=f+"px");a.selectorDiv.style.width=b-d+"px";a.selectorDiv.style.height=c-f+"px"},finishInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/
10));d=this.sketchpad;a.addPoint((new Date).getTime(),b,c);d.containerEl.removeChild(a.selectorDiv)},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e;if(c.lay&&c.lay.length)for(e=0;e<c.lay.length;e+=1){switch(c.lay[e]){case d.LAYER_BACK:var g=d.contextB2D;break;case d.LAYER_FRONT:g=d.context2D}g.save();g.rotate(d.rotation*Math.PI/180);g.scale(d.scale,d.scale);g.translate(a.vpx,a.vpy);g.translate(-d.viewportX,-d.viewportY);g.scale(1/a.scl,1/a.scl);g.rotate(-a.rot*Math.PI/180);g.clearRect(b.x[0],
b.y[0],b.x[1]-b.x[0],b.y[1]-b.y[0]);g.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolCutout);function ToolEraser(a){Tool.call(this,a)}ToolEraser.prototype=Object.create(Tool.prototype);
Object.assign(ToolEraser.prototype,{toolId:"eraser",maxLayers:"*",layers:["F","B"],lineWidth:16,minSize:2,maxSize:200,toolLabel:"Eraser",getCursor:function(){var a=parseInt(this.getSize()+1,10);return{pointer:"crosshair",marginLeft:-a/2+"px",marginTop:-a/2+"px",width:a+"px",height:a+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(255,255,255,.5)"}},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e,g;var f=null;if(c.lay&&c.lay.length)for(g=0;g<
c.lay.length;g+=1){switch(c.lay[g]){case d.LAYER_BACK:f=d.contextB2D;break;case d.LAYER_FRONT:f=d.context2D}f.save();f.globalCompositeOperation="destination-out";f.rotate(d.rotation*Math.PI/180);f.scale(d.scale,d.scale);f.translate(a.vpx,a.vpy);f.translate(-d.viewportX,-d.viewportY);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*Math.PI/180);if(b&&b.x&&b.y&&1<b.x.length)for(e=1;e<b.x.length;e+=1){var h=b.x[e-1];var k=b.y[e-1];var l=b.x[e];var m=b.y[e];f.beginPath();f.strokeStyle=this.getColorStr(h,k);f.lineCap=
"miter";f.lineJoin="miter";f.lineWidth=c.siz;f.moveTo(h,k);f.lineTo(l,m);f.stroke()}f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolEraser);function ToolHighlighter(a){Tool.call(this,a)}ToolHighlighter.prototype=Object.create(Tool.prototype);
Object.assign(ToolHighlighter.prototype,{toolId:"highlighter",color:{r:255,g:255,b:15,a:.5},layers:["F"],lineWidth:16,keyCode:72,toolLabel:"Highlighter",getCursor:function(){var a=parseInt(this.getSize(),10);a=a/2+a/(a/5);return{pointer:"none",marginLeft:-a/2+"px",marginTop:-a/2+"px",width:a+"px",height:a+"px",border:"none",borderRadius:0,backgroundColor:this.getColorStr()}},drawFramePath:function(a,b){var c=this.sketchpad,d,e,g=a.cnf;if(g.lay&&g.lay.length)for(e=0;e<g.lay.length;e+=1){switch(g.lay[e]){case c.LAYER_BACK:var f=
c.contextB2D;break;case c.LAYER_FRONT:f=c.context2D;break;default:f=c.context2D}f.save();f.lineCap="butt";f.lineJoin="round";f.rotate(c.rotation*Math.PI/180);f.scale(c.scale,c.scale);f.translate(a.vpx,a.vpy);f.translate(-c.viewportX,-c.viewportY);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*Math.PI/180);f.strokeStyle=g.col;f.lineWidth=g.siz;if(b&&b.x&&1<b.x.length)for(d=1;d<b.x.length;d+=1){var h=b.x[d-1];var k=b.y[d-1];var l=b.x[d];var m=b.y[d];f.beginPath();f.lineWidth=g.siz/2+g.siz/(g.siz/5+this.distance(h,
k,l,m)/10);f.moveTo(h,k);f.lineTo(l,m);f.stroke()}f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolHighlighter);
function ToolImage(a){Tool.call(this,a);var b=this;this.emptyImage=document.createElement("img");this.emptyImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAArrAAAK6wGCiw1aAAAAB3RJTUUH4QQJFQY3bU7o3wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAACR0lEQVR42uWbsU7rMBSG//ObMRkQguVKvAHv/wrsvEGlLiDUIdHd7MNAkHp7AzSJ7WM7lrK0Q+Uv+b6kR4oAeAbwAkCmYw9Lp+PpZtr8X+/9iaTuYfchBHHO3QJ4IQDx3p+cc/c7Oftwzt17708AhACEpKrqq4g8tr55EXlU1dfpahf+I4bqoWUI0+YP55/xvzp8QngYx9G1svFxHJ2IPFxufhYAAAzD8N73/V0rAPq+vxuG4X3uu1kAXdf5Vprw5XzXdf5qAK00Yc75RQBqbcJPzi8GUGMTfnJ+FYCamvCb86sA1NKEa5zfBKDUJixxfjOAEpuwxPkoAEpqwlLnowAopQlrnI8KwKoJW5yPDsCiCVucTwIgZxO2Op8EQK4mxHA+KYBUTYjpfHIAKZoQ0/ksAGI2IbbzWQDEakIK57MCWNuElM5nB7CmCSmdNwGwpAmpnTcBcG0TcjhvCuC7JuR03hzAXBNyOn+5bix+9KwJf6ar4mj1l5rY+TIBcOb8UVWPljNGEwCXzlvOGLMDmLvPW84YabD5g9U8wQzAkvt87hkjLZzPPU8wBbDm2T5nE2jpfOp5ghmAmM/2qZvAEpy3bAJLcN6yCSzJeYsmsDTnczeBJTqfswks0fmcTWDJzudoAkt3PnUTWIPzKZvAGpxP2QTW5HyKJrA252M3gTU6H7MJrNH5mE1gzc7HaAJrd35rE9iC81uawBac39IEtuT8miYQgIYQpBXnr21CCEEAKAGoc+7We/+GnSzv/dv08rQKdv76/Af/G22JqgLBTAAAAABJRU5ErkJggg==";var c=
this.sketchpad;document.addEventListener("paste",function(d){if(!b.disabled){var e=d.clipboardData&&d.clipboardData.items||d.originalEvent.clipboardData&&d.originalEvent.clipboardData.items;Object.keys(e).forEach(function(g){g=e[g];"file"===g.kind&&(g=g.getAsFile(),window.tmp=(new Imagehost({progressParentEl:c.progressParentEl||c.containerEl,file:g})).on("success",function(f){b.onImagehostReady(f.url,0,0,0,0,!0)}).on("error",b.onImagehostError.bind(b)))})}});this.sketchpad.containerEl.addEventListener("dragover",
function(d){b.disabled||d.preventDefault()});this.sketchpad.containerEl.addEventListener("dragenter",function(d){});this.sketchpad.containerEl.addEventListener("drop",function(d){if(!b.disabled){var e=b.sketchpad.mainPos(d.clientX,d.clientY),g=d.dataTransfer.getData("URL");if(g)window.tmp=(new Imagehost({progressParentEl:c.progressParentEl||c.containerEl,url:g})).on("success",function(h){b.onImagehostReady(h.url,e.x,e.y,e.x,e.y)}).on("error",b.onImagehostError.bind(b)),d.preventDefault();else if((g=
d.dataTransfer.getData("text/html").match(/<img.+src=(?:"|')(.+?)(?:"|')(?:.+?)>/))&&g[1]){var f=document.createElement("span");f.innerHTML=g[1];console.log("URL PARSED",encodeURI(f.textContent));window.tmp=(new Imagehost({progressParentEl:c.progressParentEl||c.containerEl,url:encodeURI(f.textContent)})).on("success",function(h){b.onImagehostReady(h.url,e.x,e.y,e.x,e.y)}).on("error",b.onImagehostError.bind(b));d.preventDefault()}else g=d.dataTransfer.files,0<g.length&&(g=g[0],void 0===FileReader||
-1===g.type.indexOf("image")&&-1===g.type.indexOf("pdf")||(window.tmp=(new Imagehost({progressParentEl:c.progressParentEl||c.containerEl,file:g})).on("success",function(h){b.onImagehostReady(h.url,e.x,e.y,e.x,e.y)}).on("error",b.onImagehostError.bind(b))),d.preventDefault())}})}ToolImage.prototype=Object.create(Tool.prototype);
Object.assign(ToolImage.prototype,{layers:["F"],toolLabel:"Image",toolId:"image",keyCode:79,disabled:!1,fieldThreshold:100,disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},getCursor:function(){return{pointer:"crosshair",backgroundColor:"rgba(0,0,0,0)",borderRadius:"0",border:"none"}},onImagehostError:function(a){popnotifications.notification(a.title,a.message)},onImagehostReady:function(a,b,c,d,e,g){a=new Input({sketchpad:this.sketchpad,id:777,tool:this.toolId,layers:this.layers,
url:a,center:g});this.sketchpad.inputs[777]=a;a.addPoint((new Date).getTime(),b,c);a.addPoint((new Date).getTime(),d,e,"force");this.sketchpad.sendInputs();this.sketchpad.drawInputs();delete this.sketchpad.inputs[777]},startInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,layers:this.layers});a.firstX=b;a.firstY=c;a.selectorDiv=document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.border=
"1px solid black";a.selectorDiv.style.outline="1px dashed white";a.selectorDiv.style.outlineOffset="-1px";a.selectorDiv.style.display="block";this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";a.selectorDiv.style.height="1px";d.containerEl.appendChild(a.selectorDiv);return a},moveInput:function(a,b,c,d){d.altKey&&
(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=a.firstX,g=a.firstY;Math.abs(e-b)<this.fieldThreshold||Math.abs(g-c)<this.fieldThreshold?Math.abs(e-b)<Math.abs(g-c)?(a.selectorDiv.style.background="linear-gradient(to right, rgba(0,0,0,.2), transparent)",a.selectorDiv.style.border="1px dashed #888",a.selectorDiv.style.boxSizing="border-box",a.selectorDiv.style.borderRight="",a.selectorDiv.style.outline="",b=e+100):(a.selectorDiv.style.background="linear-gradient(to bottom, rgba(0,0,0,.2), transparent)",
a.selectorDiv.style.border="1px dashed #888",a.selectorDiv.style.boxSizing="border-box",a.selectorDiv.style.borderBottom="",a.selectorDiv.style.outline="",c=g+100):(a.selectorDiv.style.outline="1px dashed white",a.selectorDiv.style.border="1px solid black",a.selectorDiv.style.boxSizing="",a.selectorDiv.style.background="",a.selectorDiv.style.filter="");var f=Math.abs(c-g);d.shiftKey&&(b=b<e?e-f:e+f);d=Math.min(e,b);f=Math.min(g,c);b=Math.max(e,b);c=Math.max(g,c);this.sketchpad.centerViewport?(a.selectorDiv.style.left=
this.sketchpad.width/2+d-1+"px",a.selectorDiv.style.top=this.sketchpad.height/2+f-1+"px"):(a.selectorDiv.style.left=d+"px",a.selectorDiv.style.top=f+"px");a.selectorDiv.style.width=b-d+"px";a.selectorDiv.style.height=c-f+"px"},finishInput:function(a,b,c,d){function e(){document.body.removeChild(m);window.removeEventListener("focus",e)}function g(p){n.onImagehostReady(p.url,h,k,b,c)}d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var f=this.sketchpad,h=a.firstX,k=a.firstY;if(Math.abs(h-b)<
this.fieldThreshold||Math.abs(k-c)<this.fieldThreshold)Math.abs(h-b)<Math.abs(k-c)?b=h:c=k;var l=Math.abs(c-k);d.shiftKey&&(b=b<h?h-l:h+l);var m=document.createElement("input");m.type="file";m.style.position="fixed";m.style.display="none";m.accept=".jpg,.jpeg,.png,.gif,.svg,image/*;capture=camera";document.body.appendChild(m);m.click();window.addEventListener("focus",e);var n=this;m.addEventListener("change",function(p){p=p.target.files;var r;for(r=0;r<p.length;r+=1){var q=p[r];window.tmp=(new Imagehost({progressParentEl:f.progressParentEl||
f.containerEl,file:q})).on("success",g).on("error",n.onImagehostError.bind(n))}});f.containerEl.removeChild(a.selectorDiv)},drawFramePath:function(a,b){var c,d,e,g;function f(q){for(l=0;l<h.lay.length;l+=1){switch(h.lay[l]){case k.LAYER_BACK:m=k.contextB2D;break;case k.LAYER_FRONT:m=k.context2D;break;default:m=k.context2D}m.save();m.beginPath();m.rotate(k.rotation*Math.PI/180);m.scale(k.scale,k.scale);m.translate(a.vpx,a.vpy);m.translate(-k.viewportX,-k.viewportY);m.scale(1/a.scl,1/a.scl);m.rotate(-a.rot*
Math.PI/180);e=Math.min(b.x[0],b.x[1]);g=Math.min(b.y[0],b.y[1]);c=Math.max(b.x[0],b.x[1]);d=Math.max(b.y[0],b.y[1]);n=c-e;p=d-g;1>n&&1>p&&(n=q.width,p=q.height);1>n&&(n=p/q.height*q.width);1>p&&(p=n/q.width*q.height);h.cen&&(e-=q.width/2,g-=q.height/2);m.drawImage(q,e,g,n,p);m.restore()}}var h=a.cnf,k=this.sketchpad,l,m;if(h&&h.lay&&h.lay.length){var n,p,r=this;h.url?k.resources.getImage(h.url,function(q){q.success&&f(q.img)},function(q){console.warn("error loading image",h.url,q);r.emptyImage.complete&&
r.emptyImage.naturalWidth?f(r.emptyImage):r.emptyImage.addEventListener("load",function(){f(r.emptyImage)})}):console.log("error url")}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolImage);function ToolLine(a){Tool.call(this,a);this.toolId=a.toolId||"line"}ToolLine.prototype=Object.create(Tool.prototype);
Object.assign(ToolLine.prototype,{color:{r:0,g:0,b:0,a:1},toolLabel:"Line",toolKey:"l",toolId:"line",lineWidth:1,keyCode:76,startInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,color:this.getColorStr(),size:this.lineWidth,layers:this.layers});a.selectorDiv=document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.display="block";a.selectorDiv.style.backgroundColor=this.getColorStr();
this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";var e=this.getSize();1>e&&(a.selectorDiv.style.borderTop="1px dashed "+this.getColorStr());a.selectorDiv.style.height=e+"px";a.startX=b;a.startY=c;d.containerEl.appendChild(a.selectorDiv);a.addPoint((new Date).getTime(),b,c);return a},connect:function(a,b,c,d,e,
g){var f=Math.sqrt((d-b)*(d-b)+(e-c)*(e-c)),h=(b+d)/2-f/2;g=(c+e)/2-g/2;b=180/Math.PI*Math.atan2(c-e,b-d);this.sketchpad.centerViewport?(a.style.left=this.sketchpad.width/2+h+"px",a.style.top=this.sketchpad.height/2+g+"px"):(a.style.left=h+"px",a.style.top=g+"px");a.style.width=f+"px";a.style.transform="rotate("+b+"deg)";a.style.webkitTransform="rotate("+b+"deg)";a.style.MozTransform="rotate("+b+"deg)";a.style.msTransform="rotate("+b+"deg)";a.style.OTransform="rotate("+b+"deg)"},moveInput:function(a,
b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=a.startX,g=a.startY;if(d.shiftKey){d=b-e;var f=c-g;c=this.distance(e,g,b,c);d=Math.PI/4*Math.round(Math.atan2(d,f)/(Math.PI/4));b=e+c*Math.sin(d);c=g+c*Math.cos(d)}this.connect(a.selectorDiv,e,g,b,c,this.getSize())},finishInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=this.sketchpad,g=a.startX,f=a.startY;if(d.shiftKey){d=b-g;var h=c-f;c=this.distance(g,f,b,c);d=Math.PI/4*Math.round(Math.atan2(d,
h)/(Math.PI/4));b=g+c*Math.sin(d);c=f+c*Math.cos(d)}a.addPoint((new Date).getTime(),b,c);e.containerEl.removeChild(a.selectorDiv)},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e;if(c.lay&&c.lay.length)for(e=0;e<c.lay.length;e+=1){switch(c.lay[e]){case d.LAYER_BACK:var g=d.contextB2D;break;case d.LAYER_FRONT:g=d.context2D;break;default:g=d.context2D}g.save();g.rotate(d.rotation*Math.PI/180);g.scale(d.scale,d.scale);g.translate(a.vpx,a.vpy);g.translate(-d.viewportX,-d.viewportY);g.scale(1/
a.scl,1/a.scl);g.rotate(-a.rot*Math.PI/180);g.beginPath();g.lineCap="round";g.lineJoin="round";g.strokeStyle=c.col;g.lineWidth=c.siz;g.moveTo(b.x[0],b.y[0]);g.lineTo(b.x[1],b.y[1]);g.stroke();g.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolLine);function ToolMandala(a){Tool.call(this,a)}ToolMandala.prototype=Object.create(Tool.prototype);
Object.assign(ToolMandala.prototype,{layers:["F"],axis:7,color:{r:0,g:0,b:0,a:1},toolId:"mandala",toolLabel:"Mandala",lineWidth:1,keyCode:77,mirrorV:!1,mirrorH:!0,mirrorVH:!1,rainbow:!1,hideByDefault:!1,getToolConfig:function(){var a=Tool.prototype.getToolConfig.call(this);return Object.assign(a,{axis:this.axis,mirrorV:this.mirrorV,mirrorH:this.mirrorH,mirrorVH:this.mirrorVH,rainbow:this.rainbow})},setToolConfig:function(a){Tool.prototype.setToolConfig.call(this,a);parseInt(a.axis,10)&&(this.axis=
parseInt(a.axis,10));this.mirrorV=a.mirrorV;this.mirrorH=a.mirrorH;this.mirrorVH=a.mirrorVH;this.rainbow=a.rainbow;this.dispatch("changeParams");return this},startInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));a=Tool.prototype.startInput.call(this,a,b,c);a.mirrorV=this.mirrorV;a.mirrorH=this.mirrorH;a.mirrorVH=this.mirrorVH;a.rainbow=this.rainbow;a.axis=this.axis;return a},getRbwColorStr:function(a,b){var c=Math.abs(Math.floor(255*Math.sin(a/50)))%255;return"rgba("+
c+","+Math.abs(Math.floor(255*Math.cos(b/50)))%255+","+Math.abs(Math.floor(255*Math.cos(a/50)))%255+",1)"},drawFramePath:function(a,b){function c(t,u,v,w){return{x:Math.cos(v)*t-Math.sin(v)*u,y:Math.sin(v)*t+Math.cos(v)*u}}function d(t,u,v){t.save();t.beginPath();t.rotate(g.rotation*Math.PI/180);t.scale(g.scale,g.scale);t.translate(a.vpx,a.vpy);t.translate(-g.viewportX,-g.viewportY);t.scale(1/a.scl,1/a.scl);t.rotate(-a.rot*Math.PI/180);t.lineWidth=e.siz;t.strokeStyle=e.rbw?m.getRbwColorStr(u.x,u.y):
e.col;t.moveTo(u.x,u.y);t.lineTo(v.x,v.y);t.stroke();t.restore()}var e=a.cnf,g=this.sketchpad,f,h,k=e.axs,l;if(e.lay&&e.lay.length){var m=this;for(h=0;h<e.lay.length;h+=1){switch(e.lay[h]){case g.LAYER_BACK:var n=g.contextB2D;break;case g.LAYER_FRONT:n=g.context2D;break;default:n=g.context2D}if(b&&b.x&&1<b.x.length)for(f=1;f<b.x.length;f+=1)for(l=0;l<k;l+=1){var p=2*l*Math.PI/k;var r=c(b.x[f-1],b.y[f-1],p,l);var q=c(b.x[f],b.y[f],p,l);d(n,r,q);e.mrh&&(r=c(b.x[f-1],-b.y[f-1],p,l),q=c(b.x[f],-b.y[f],
p,l),d(n,r,q));e.mrv&&(r=c(-b.x[f-1],b.y[f-1],p,l),q=c(-b.x[f],b.y[f],p,l),d(n,r,q));e.mrvh&&(r=c(-b.x[f-1],-b.y[f-1],p,l),q=c(-b.x[f],-b.y[f],p,l),d(n,r,q))}}}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolMandala);function ToolMoveViewport(a){Tool.call(this,a);this.toolId=a.toolId||"move-viewport";this.layers=[]}ToolMoveViewport.prototype=Object.create(Tool.prototype);
Object.assign(ToolMoveViewport.prototype,{maxLayers:0,keyCode:32,toolLabel:"Move",toolId:"move-viewport",getCursor:function(){return{pointer:"move",border:"none",borderRadius:0,backgroundColor:"rgba(0,0,0,0)"}},startInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId});a.tmpCursor=this.sketchpad.containerEl.style.cursor;a.startX=b;a.startY=c;a.viewportX=this.sketchpad.viewportX;a.viewportY=this.sketchpad.viewportY;
d.containerEl.style.cursor="move";d.hudsEl.style.opacity=0;return a},moveInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));c={x:1/this.sketchpad.scale*(b-a.startX),y:1/this.sketchpad.scale*(c-a.startY)};c=this.rotate(-this.sketchpad.rotation,c);b=a.viewportX-c.x;a=a.viewportY-c.y;d&&d.shiftKey&&(b=10*Math.round(b/10),a=10*Math.round(a/10));this.sketchpad.setViewportPosition(b,a)},finishInput:function(a,b,c,d){d&&d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));
this.moveInput(a,b,c,d);this.sketchpad.containerEl.style.cursor=a.tmpCursor;this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}});NSSketchpad.avaliableTools.push(ToolMoveViewport);function ToolNull(a){Tool.call(this,a);this.toolId=a.toolId||"null";this.layers=[]}ToolNull.prototype=Object.create(Tool.prototype);
Object.assign(ToolNull.prototype,{maxLayers:0,keyCode:27,toolLabel:"Null",toolId:"null",startInput:function(a){var b=this.sketchpad;a=new Input({sketchpad:b,id:a,tool:this.toolId});a.tmpCursor=this.sketchpad.containerEl.style.cursor;b.containerEl.style.cursor="none";return a},moveInput:function(){},finishInput:function(a){this.sketchpad.containerEl.style.cursor=a.tmpCursor},drawFramePath:function(){}});NSSketchpad.avaliableTools.push(ToolNull);function ToolPen(a){Tool.call(this,a)}
ToolPen.prototype=Object.create(Tool.prototype);Object.assign(ToolPen.prototype,{color:{r:0,g:0,b:0,a:1},lineWidth:1,layers:["F"],keyCode:80,toolId:"pen",toolLabel:"Pen"});NSSketchpad.avaliableTools.push(ToolPen);function ToolRainbow(a){Tool.call(this,a)}ToolRainbow.prototype=Object.create(Tool.prototype);
Object.assign(ToolRainbow.prototype,{toolId:"rainbow",lineWidth:1,keyCode:74,toolLabel:"Rainbow",hideByDefault:!1,getCursor:function(){var a=parseInt(this.getSize()+1,10);a+=10;return{pointer:"crosshair",marginLeft:-a/2+"px",marginTop:-a/2+"px",width:a+"px",height:a+"px",border:"1px solid black",boxSizing:"border-box",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},getColorStr:function(a,b){this.color.r=Math.floor(256*Math.sin(a/50));this.color.g=Math.floor(256*Math.cos(b/50));this.color.b=Math.floor(256*
Math.cos(a/50));this.color.a=1;return"rgba("+this.color.r+","+this.color.g+","+this.color.b+","+this.color.a+")"},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e,g;if(c.lay&&c.lay.length)for(g=0;g<c.lay.length;g+=1){switch(c.lay[g]){case d.LAYER_BACK:var f=d.contextB2D;break;case d.LAYER_FRONT:f=d.context2D;break;default:f=d.context2D}f.save();f.rotate(d.rotation*Math.PI/180);f.scale(d.scale,d.scale);f.translate(a.vpx,a.vpy);f.translate(-d.viewportX,-d.viewportY);f.scale(1/a.scl,1/a.scl);
f.rotate(-a.rot*Math.PI/180);if(b&&b.x&&b.y&&1<b.x.length)for(e=1;e<b.x.length;e+=1){var h=b.x[e-1];var k=b.y[e-1];var l=b.x[e];var m=b.y[e];f.beginPath();f.strokeStyle=this.getColorStr(h,k);f.lineCap="miter";f.lineJoin="miter";f.lineWidth=c.siz+100/(10+this.distance(h,k,l,m));f.moveTo(h,k);f.lineTo(l,m);f.stroke()}f.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolRainbow);function ToolRect(a){ToolFillable.call(this,a)}ToolRect.prototype=Object.create(ToolFillable.prototype);
Object.assign(ToolRect.prototype,{layers:["F"],toolLabel:"Rectangle",toolId:"rectangle",keyCode:82,lineWidth:1,color:hexToRgbA(setPallete_HEX.value),fillColor:hexToRgbA(setPallete_HEX.value),startInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,color:this.getColorStr(),fillColor:this.getFillColorStr(),size:this.lineWidth,layers:this.layers});a.firstX=b;a.firstY=c;a.selectorDiv=document.createElement("div");
a.selectorDiv.style.position="absolute";a.selectorDiv.style.border="1px solid black";a.selectorDiv.style.outline="1px dashed white";a.selectorDiv.style.outlineOffset="-1px";a.selectorDiv.style.display="block";this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";a.selectorDiv.style.height="1px";d.containerEl.appendChild(a.selectorDiv);
a.addPoint((new Date).getTime(),b,c);return a},moveInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=a.firstX,g=a.firstY,f=Math.abs(c-g);d.shiftKey&&(b=b<e?e-f:e+f);d=Math.min(e,b);f=Math.min(g,c);b=Math.max(e,b);c=Math.max(g,c);this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+d-1+"px",a.selectorDiv.style.top=this.sketchpad.height/2+f-1+"px"):(a.selectorDiv.style.left=d+"px",a.selectorDiv.style.top=f+"px");a.selectorDiv.style.width=
b-d+"px";a.selectorDiv.style.height=c-f+"px"},finishInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=this.sketchpad,g=a.firstX,f=Math.abs(c-a.firstY);d.shiftKey&&(b=b<g?g-f:g+f);a.addPoint((new Date).getTime(),b,c);e.containerEl.removeChild(a.selectorDiv)},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e;if(c.lay&&c.lay.length)for(e=0;e<c.lay.length;e+=1){switch(c.lay[e]){case d.LAYER_BACK:var g=d.contextB2D;break;case d.LAYER_FRONT:g=d.context2D;break;
default:g=d.context2D}g.save();g.beginPath();g.strokeStyle=c.col;g.fillStyle=c.fcl;g.lineWidth=c.siz;g.rotate(d.rotation*Math.PI/180);g.scale(d.scale,d.scale);g.translate(a.vpx,a.vpy);g.translate(-d.viewportX,-d.viewportY);g.scale(1/a.scl,1/a.scl);g.rotate(-a.rot*Math.PI/180);var f=b.x[0];var h=b.y[0];var k=b.x[1];var l=b.y[1];g.rect(f,h,k-f,l-h);g.fill();g.stroke();g.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolRect);
function ToolRotateViewport(a){Tool.call(this,a);this.toolId=a.toolId||"rotate-viewport";this.layers=[]}ToolRotateViewport.prototype=Object.create(Tool.prototype);
Object.assign(ToolRotateViewport.prototype,{maxLayers:0,keyCode:32,toolLabel:"Rotate",toolId:"rotate-viewport",getCursor:function(){return{pointer:"default",border:"none",borderRadius:"50%",backgroundColor:"rgba(0,0,0,0)"}},startInput:function(a,b,c){var d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId});a.startRotation=d.rotation;a.startX=b;a.startY=c;a.viewportX=this.sketchpad.viewportX;a.viewportY=this.sketchpad.viewportY;d.hudsEl.style.opacity=0;return a},moveInput:function(a,b,
c,d){b=180*Math.atan2(b,c)/Math.PI-180*Math.atan2(a.startX,a.startY)/Math.PI;d.shiftKey&&(b=15*Math.round(b/15));this.sketchpad.setRotation((-b+a.startRotation)%360)},finishInput:function(a){this.sketchpad.hudsEl.style.opacity=1},drawFramePath:function(){}});NSSketchpad.avaliableTools.push(ToolRotateViewport);function ToolSmoothpen(a){Tool.call(this,a)}ToolSmoothpen.prototype=Object.create(Tool.prototype);
Object.assign(ToolSmoothpen.prototype,{color:{r:0,g:0,b:0,a:1},lineWidth:1,layers:["F"],keyCode:66,toolId:"smoothpen",toolLabel:"Smooth Pen",smoothLength:16,smoothFactor:.2,minDist:0,minTime:0,connect:function(a,b,c,d,e,g){var f=Math.sqrt((d-b)*(d-b)+(e-c)*(e-c)),h=(b+d)/2-f/2;g=(c+e)/2-g/2;b=180/Math.PI*Math.atan2(c-e,b-d);this.sketchpad.centerViewport?(a.style.left=this.sketchpad.width/2+h+"px",a.style.top=this.sketchpad.height/2+g+"px"):(a.style.left=h+"px",a.style.top=g+"px");a.style.width=f+
"px";a.style.transform="rotate("+b+"deg)";a.style.webkitTransform="rotate("+b+"deg)";a.style.MozTransform="rotate("+b+"deg)";a.style.msTransform="rotate("+b+"deg)";a.style.OTransform="rotate("+b+"deg)"},smooth:function(a){var b=this.smoothFactor;if(!(2>a.length)){var c=a.length-this.smoothLength;for(1>c&&(c=1);c<a.length;c+=1){var d=a[c];var e=a[c-1];d={x:d.x*(1-b)+e.x*b,y:d.y*(1-b)+e.y*b,t:d.t};a[c]=d}}},drawProjector:function(a){var b=a.viewportX,c=a.viewportY,d=a.scale,e=a.rotation,g=this.sketchpad,
f=a.preInput;if(!(2>f.length)){g.clearProjector();var h=g.contextProjector2D;h.save();h.rotate(g.rotation*Math.PI/180);h.scale(g.scale,g.scale);h.translate(b,c);h.translate(-g.viewportX,-g.viewportY);h.scale(1/d,1/d);h.rotate(-e*Math.PI/180);b=f[0];h.beginPath();h.strokeStyle=this.getColorStr();h.lineCap="miter";h.lineJoin="miter";h.moveTo(b.x,b.y);for(i=1;i<f.length;i+=1)b=f[i-1],c=f[i],this.distance(b.x,b.y,c.x,c.y),h.lineWidth=a.size,h.lineTo(c.x,c.y);h.stroke();h.restore()}},startInput:function(a,
b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));d=this.sketchpad;a=new Input({sketchpad:d,id:a,tool:this.toolId,color:this.getColorStr(),size:this.lineWidth,layers:this.layers,preInput:[]});a.selectorDiv=document.createElement("div");a.selectorDiv.style.position="absolute";a.selectorDiv.style.display="none";a.selectorDiv.style.backgroundColor=this.getColorStr();this.sketchpad.centerViewport?(a.selectorDiv.style.left=this.sketchpad.width/2+b+"px",a.selectorDiv.style.top=this.sketchpad.height/
2+c+"px"):(a.selectorDiv.style.left=b+"px",a.selectorDiv.style.top=c+"px");a.selectorDiv.style.width="1px";var e=this.getSize();1>e&&(a.selectorDiv.style.borderTop="1px dashed "+this.getColorStr());a.selectorDiv.style.height=e+"px";e=(new Date).getTime();a.preInput=[];a.startX=b;a.startY=c;a.startT=e;a.lastX=b;a.lastY=c;a.lastT=e;d.containerEl.appendChild(a.selectorDiv);a.preInput.push({t:e,x:b,y:c});this.drawProjector(a);return a},moveInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*
Math.round(c/10));if(d&&d.shiftKey&&(d=a.getLastPoint())&&(10>Math.abs(d.x-b)&&(b=d.x),10>Math.abs(d.y-c)&&(c=d.y),d.x===b&&d.y===c))return!1;d=(new Date).getTime();a.lastT=d;a.lastX=b;a.lastY=c;a.preInput.push({t:d,x:b,y:c});this.smooth(a.preInput);this.connect(a.selectorDiv,a.preInput[0].x,a.preInput[0].y,b,c,this.getSize());this.drawProjector(a)},finishInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var e=this.sketchpad,g=a.startX,f=a.startY;if(d.shiftKey){d=b-g;
var h=c-f;c=this.distance(g,f,b,c);d=Math.PI/4*Math.round(Math.atan2(d,h)/(Math.PI/4));b=g+c*Math.sin(d);c=f+c*Math.cos(d)}var k=(new Date).getTime();a.preInput.push({t:k,x:b,y:c});this.smooth(a.preInput);e.containerEl.removeChild(a.selectorDiv);this.drawProjector(a);a.preInput.forEach(function(l){a.addPoint(k,l.x,l.y)});e.clearProjector()},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e,g;if(c.lay&&c.lay.length)for(g=0;g<c.lay.length;g+=1){switch(c.lay[g]){case d.LAYER_BACK:var f=d.contextB2D;
break;case d.LAYER_FRONT:f=d.context2D;break;default:f=d.context2D}f.save();f.rotate(d.rotation*Math.PI/180);f.scale(d.scale,d.scale);f.translate(a.vpx,a.vpy);f.translate(-d.viewportX,-d.viewportY);f.scale(1/a.scl,1/a.scl);f.rotate(-a.rot*Math.PI/180);if(b&&b.x&&b.y&&1<b.x.length){var h=b.x[0];var k=b.y[0];f.beginPath();f.strokeStyle=c.col;f.lineCap="miter";f.lineJoin="miter";f.lineWidth=c.siz;f.moveTo(h,k);for(e=1;e<b.x.length;e+=1)h=b.x[e],k=b.y[e],f.lineTo(h,k);f.stroke()}f.restore()}else console.warn("no layers to draw")}});
NSSketchpad.avaliableTools.push(ToolSmoothpen);function ToolType(a){Tool.call(this,a);this.toolId=a.toolId||"type"}ToolType.prototype=Object.create(Tool.prototype);
Object.assign(ToolType.prototype,{toolLabel:"Text",toolId:"type",font:"Arial",keyCode:84,color:{r:0,g:0,b:0,a:1},size:14,getToolConfig:function(){var a=Tool.prototype.getToolConfig.call(this);return Object.assign(a,{font:this.getFont(),size:this.getSize()})},setToolConfig:function(a){Tool.prototype.setToolConfig.call(this,a);parseFloat(a.size)&&this.setSize(parseFloat(a.size));a.font&&this.setFont(a.font);this.dispatch("changeParams");return this},setSize:function(a){this.size=parseFloat(a);this.dispatch("changeParams");
return this},getSize:function(){return this.size},setFont:function(a){this.font=a;this.dispatch("changeParams");return this},getFont:function(){return this.font},startInput:function(a,b,c,d){function e(){if(l.typeInput.written&&m)return!1;l.typeInput.written=!0;l.addPoint((new Date).getTime(),l.x-1,l.y);l.addPoint((new Date).getTime(),l.x,l.y);l.textContent=l.typeInput.value;k.inputs[667]=l;k.sendInputs();k.drawInputs();delete k.inputs[667];k.containerEl.removeChild(l.typeInput);g.addEventListener("click",
function(n){m=!0})}d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));var g=document.body.querySelector('div[data-v-ebbacb64=""]');d=document.body.querySelector('select[data-v-28064cda=""]').value;var f=document.body.querySelector("select[data-v-d6eb0194").value;document.body.querySelector("button[data-v-ebbacb64");var h=document.body.querySelector("#inputPalette");console.log();var k=this.sketchpad,l=new Input({sketchpad:k,id:a,tool:this.toolId,color:h.value,font:d,size:f,layers:this.layers});
fontLoad.style.display="block";l.typeInput=document.createElement("input");var m=!0;l.typeInput.value="Enter text";l.typeInput.placeholder="Enter text";l.typeInput.style.border=0;l.typeInput.style.boxShadow="none";l.typeInput.style.position="absolute";l.typeInput.style.outline="0";l.typeInput.style.overflow="hidden";l.typeInput.style.padding=0;l.typeInput.style.margin=0;l.typeInput.style.fontFamily=this.getFont();l.typeInput.style.fontSize=f/1.2+"px";l.typeInput.style.display="inline-block";l.typeInput.style.color=
h.value;l.typeInput.style.backgroundColor="rgba(255,255,255,0)";this.sketchpad.centerViewport?(l.typeInput.style.left=this.sketchpad.width/2+b-1+"px",l.typeInput.style.top=this.sketchpad.height/2+c-this.getSize()/2+"px"):(l.typeInput.style.left=b-1+"px",l.typeInput.style.top=c-this.getSize()/2+"px");l.typeInput.style.width="350px";l.typeInput.style.height=f+"px";l.typeInput.addEventListener("blur",e);l.typeInput.addEventListener("change",e);l.typeInput.addEventListener("keyup",function(n){13!==n.keyCode||
m||e();27!==n.keyCode||m||(l.typeInput.value="",e())});k.containerEl.appendChild(l.typeInput);return l},moveInput:function(a,b,c,d){a.typeInput.focus();"use strict";d.altKey&&(b=10*Math.round(b/10),c=10*Math.round(c/10));c-=this.getSize()/2;this.sketchpad.centerViewport?(a.typeInput.style.left=this.sketchpad.width/2+b+"px",a.typeInput.style.top=this.sketchpad.height/2+c+"px"):(a.typeInput.style.left=b+"px",a.typeInput.style.top=c+"px")},finishInput:function(a,b,c,d){d.altKey&&(b=10*Math.round(b/10),
c=10*Math.round(c/10));a.x=b;a.y=c;a.typeInput.value="";a.typeInput.focus();a.typeInput.select()},drawFramePath:function(a,b){var c=a.cnf,d=this.sketchpad,e;if(c.lay&&c.lay.length)for(e=0;e<c.lay.length;e+=1){switch(c.lay[e]){case d.LAYER_BACK:var g=d.contextB2D;break;case d.LAYER_FRONT:g=d.context2D;break;default:g=d.context2D}g.save();g.rotate(d.rotation*Math.PI/180);g.scale(d.scale,d.scale);g.translate(a.vpx,a.vpy);g.translate(-d.viewportX,-d.viewportY);g.scale(1/a.scl,1/a.scl);g.rotate(-a.rot*
Math.PI/180);g.font=c.siz+"px "+c.fnt;g.fillStyle=c.col;g.textAlign="left";g.textBaseline="middle";g.fillText(c.txt,b.x[0],b.y[0]);g.restore()}else console.warn("no layers to draw")}});NSSketchpad.avaliableTools.push(ToolType);function calculateOffsetXY(a,b,c){var d=a.currentStyle||window.getComputedStyle(a,null),e=parseInt(d.borderLeftWidth,10)||0;d=parseInt(d.borderTopWidth,10)||0;a=a.getBoundingClientRect();return{x:b-e-a.left,y:c-d-a.top}}window.calculateOffsetXY=calculateOffsetXY;
function randomName(a){var b="aeiouy".split(""),c="bcdghjklmnprstvw".split(""),d,e="";for(d=0;d<a;d+=1)e+=c[Math.floor(Math.random()*c.length)]+b[Math.floor(Math.random()*b.length)];return e.substring(0,a)}
function Sketchpad(a){function b(){if(e.lastSendPointerX!==e.pointerX||e.lastSendPointerY!==e.pointerY)e.lastSendPointerX=e.pointerX,e.lastSendPointerY=e.pointerY,e.sendMessageToServer({cmd:"pointer-move",x:e.pointerX,y:e.pointerY});setTimeout(b,e.syncPointerDataFrequency)}function c(g){g=Object.assign({},e.config);delete g.ws;delete g.containerEl;g={cmd:"open",user_id:e.UID,user_color:e.COLOR,user_name:e.USER_NAME,room_token:e.token,room_password:e.password,room_config:g,viewportX:parseFloat(e.viewportX)||
0,viewportY:parseFloat(e.viewportY)||0,width:parseFloat(e.width)||0,height:parseFloat(e.height)||0,viewportScale:parseFloat(e.scale)||1,viewportZRotation:parseFloat(e.rotation)||0};g=JSON.stringify(g);e.ws.send(g);e.dispatch("initConnection")}Eventsmanager.call(this,a);var d=randomName(6);a.features||(a.features="*");this.drawingPaused=this.initialised=!1;this.pausedQueue=[];this.displayCrosshair=!0;this.displayGrid=!1;this.user={};this.UID=a.user_id||d[0].toUpperCase()+d.substr(1);this.COLOR=a.user_color||
randomColor();this.USER_NAME=a.user_name||this.UID;this.viewersCount=this.editorsCount=0;this.renderFadeEffectTransitionOut={transition:"all 1s linear",opacity:.3};this.renderFadeEffectTransitionIn={transition:"all 1s linear",opacity:1};this.postponeChunkLength=30;this.resources=new Resources({sketchpad:this});a=a||{};var e=this;NSSketchpad.watermarkImageSrc&&(this.watermark=new Image,this.watermark.title=NSSketchpad.watermarkTitle,this.watermark.alt="sketchpad.pro",this.watermark.style.cursor="help",
this.watermark.style.zIndex=2,this.watermark.addEventListener("click",function(){if(e.lastWatermarkSrc)e.watermark.src=e.lastWatermarkSrc,e.lastWatermarkSrc=!1;else{e.lastWatermarkSrc=e.watermark.src;var g=document.createElement("canvas");g.width=e.watermark.width;g.height=e.watermark.height+e.watermark.width;var f=(new QRCode(new Image,{text:document.location.href,width:e.watermark.width-10,height:e.watermark.width-10}))._oDrawing._elCanvas,h=g.getContext("2d");h.drawImage(e.watermark,0,e.watermark.width);
h.drawImage(f,0,0);e.watermark.src=g.toDataURL("image/png")}}),this.watermark.src=NSSketchpad.watermarkImageSrc,this.watermark.style.position="absolute",this.watermark.style.right="0px",this.watermark.style.bottom="0px",this.watermark.crossOrigin="anonymous");this.password=a.password||"";this.setMetaConfigFreeze=NaN;this.config=a;this.token=a.token||"#public";this.ws=a.ws||{addEventListener:function(){},send:function(){}};this.containerEl=a.containerEl||document.body;this.progressParentEl=a.progressParentEl||
this.containerEl;this.syncNetworkDataFrequency=a.syncNetworkDataFrequency||1E3;this.syncPointerDataFrequency=a.syncPointerDataFrequency||50;this.centerViewport=!0;this.readOnly=a.readOnly||!1;this.tools={};this.tool=null;this.viewportX=parseFloat(a.viewportX)||0;this.viewportY=parseFloat(a.viewportY)||0;this.scale=parseFloat(a.viewportScale)||1;this.rotation=parseFloat(a.viewportZRotation)||0;this.LAYER_FRONT="F";this.LAYER_BACK="B";this.receivingHistory=!1;this.inputs={};this.backgroundCanvas=document.createElement("canvas");
this.backgroundCanvas.id="backgroundCanvas";this.backgroundCanvas.style.width="100%";this.backgroundCanvas.style.height="100%";this.backgroundCanvas.style.position="absolute";this.backgroundCanvas.style.transformOrigin="0 0";this.backgroundCanvas.style.webkitTransformOrigin="0 0";this.backgroundCanvas.style.MozTransformOrigin="0 0";this.backgroundCanvas.style.msTransformOrigin="0 0";this.backgroundCanvas.style.OTransformOrigin="0 0";this.containerEl.appendChild(this.backgroundCanvas);this.backgroundIFrame=
document.createElement("iframe");this.backgroundIFrame.id="backgroundIFrame";this.backgroundIFrame.style.display="none";this.backgroundIFrame.style.position="absolute";this.backgroundIFrame.style.transformOrigin="0 0";this.backgroundIFrame.style.webkitTransformOrigin="0 0";this.backgroundIFrame.style.MozTransformOrigin="0 0";this.backgroundIFrame.style.msTransformOrigin="0 0";this.backgroundIFrame.style.OTransformOrigin="0 0";this.backgroundIFrame.style.border=0;this.containerEl.appendChild(this.backgroundIFrame);
this.background=document.createElement("img");this.background.id="background";this.background.style.position="absolute";this.background.style.transformOrigin="0 0";this.background.style.webkitTransformOrigin="0 0";this.background.style.MozTransformOrigin="0 0";this.background.style.msTransformOrigin="0 0";this.background.style.OTransformOrigin="0 0";this.containerEl.appendChild(this.background);this.hudsEl=document.createElement("div");this.hudsEl.id="huds";this.hudsEl.style.zIndex=1;this.hudsEl.style.width=
"100%";this.hudsEl.style.height="100%";this.hudsEl.style.position="absolute";this.hudsEl.style.backgroundPosition="center center";this.hudsEl.style.transformOrigin="0 0";this.hudsEl.style.webkitTransformOrigin="0 0";this.hudsEl.style.MozTransformOrigin="0 0";this.hudsEl.style.msTransformOrigin="0 0";this.hudsEl.style.OTransformOrigin="0 0";this.hudsEl.style.transition="opacity .5s";this.containerEl.appendChild(this.hudsEl);this.projectorEl=document.createElement("div");this.projectorEl.id="projector";
this.projectorEl.style.zIndex=2;this.projectorEl.style.width="100%";this.projectorEl.style.height="100%";this.projectorEl.style.position="absolute";this.projectorEl.style.backgroundPosition="center center";this.projectorEl.style.transformOrigin="0 0";this.projectorEl.style.webkitTransformOrigin="0 0";this.projectorEl.style.MozTransformOrigin="0 0";this.projectorEl.style.msTransformOrigin="0 0";this.projectorEl.style.OTransformOrigin="0 0";this.pointerEl=document.createElement("div");this.pointerEl.position=
"absolute";this.pointerEl.display="none";this.projectorEl.appendChild(this.pointerEl);this.containerEl.appendChild(this.projectorEl);this.canvas=document.createElement("canvas");this.canvas.id="canvas";this.canvas.style.width="100%";this.canvas.style.height="100%";this.canvas.style.position="absolute";this.canvasB=document.createElement("canvas");this.canvasB.id="canvasB";this.canvasB.style.width="100%";this.canvasB.style.height="100%";this.canvasB.style.position="absolute";this.canvasProjector=document.createElement("canvas");
this.canvasProjector.id="canvasProjector";this.canvasProjector.style.opacity=.8;this.canvasProjector.style.width="100%";this.canvasProjector.style.height="100%";this.canvasProjector.style.position="absolute";this.objectsCanva=document.createElement("div");this.objectsCanva.id="objectsCanva";this.objectsCanva.style.width="100%";this.objectsCanva.style.height="100%";this.objectsCanva.style.position="absolute";this.foreground=document.createElement("img");this.foreground.id="foreground";this.foreground.style.position=
"absolute";this.foreground.style.transformOrigin="0 0";this.foreground.style.webkitTransformOrigin="0 0";this.foreground.style.MozTransformOrigin="0 0";this.foreground.style.msTransformOrigin="0 0";this.foreground.style.OTransformOrigin="0 0";this.crosshairEl=document.createElement("div");this.crosshairEl.id="crosshairEl";this.crosshairEl.className="crosshair";this.crosshairEl.style.position="absolute";this.crosshairEl.style.transformOrigin="0 0";this.crosshairEl.style.webkitTransformOrigin="0 0";
this.crosshairEl.style.MozTransformOrigin="0 0";this.crosshairEl.style.msTransformOrigin="0 0";this.crosshairEl.style.OTransformOrigin="0 0";this.crosshairEl.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QAQAA9AFN/YZW7AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH4AoTDyESpvZyZAAAANxJREFUWMPtllEKwjAQRF+ipghKFVqhXs/jeAbvIOKpLMUfQVpt4k8LIkULsSxiBvZr2c0wO7sEAgICfh3Hw34t+f4S2Po00F8gsQKMJAElqoAxBuAuReAex3Ep7QErTcAL4z5jbuXuqJ055zSwAG5v+p59HLwDJgBpmgKUjezKOTdSSk2ttVetdQ24RtUoz/O2/gZsfI/Nc8yfIkuSZAdkjVL6JcynG9FnBOc3uVIpVQMXoOrIV4OvYSP7726Blu7hTcBaG/X00iAExkVRiI9A1IQVcPrrL1lAgDceLw8ximVPrtAAAAAASUVORK5CYII=')";
this.loadingEl=document.createElement("div");this.loadingEl.id="loadingEl";this.loadingEl.style.position="absolute";this.loadingEl.style.display="flex";this.loadingEl.style.width="100%";this.loadingEl.style.height="100%";this.loadingEl.style.backgroundColor="rgba(255, 255, 255, .4)";this.loadingEl.textContent="...please wait...";this.loadingEl.style.color="#000";this.loadingEl.style.justifyContent="center";this.loadingEl.style.alignItems="center";this.containerEl.style.position="relative";this.containerEl.style.overflow=
"hidden";this.containerEl.appendChild(this.canvasB);this.containerEl.appendChild(this.objectsCanva);this.containerEl.appendChild(this.canvas);this.containerEl.appendChild(this.canvasProjector);this.watermark&&this.containerEl.appendChild(this.watermark);this.containerEl.appendChild(this.foreground);this.containerEl.appendChild(this.crosshairEl);this.containerEl.appendChild(this.loadingEl);this.windowHeight=this.windowWidth=this.height=this.width=0;this.room=new Room(this.token,this);this.away=!1;
NSSketchpad.avaliableTools.forEach(function(g){e.registerTool(g.prototype.toolId,g,{})});this.setTool(NSSketchpad.defaultTool);setTimeout(function(){e.clearSketchpad();e.createEventsDraw();e.syncNetworkData();b();e.syncCanvasFrame();e.setMetaConfig(a,!1);e.ws.addEventListener("message",function(f){e.receiveMessageFromServer(f)},!0);1===e.ws.readyState?c():e.ws.addEventListener("open",c,!0);e.initialised=!0;if(e.config.createPageConfig){var g=e.room.addSketch(e,e.config.createPageConfig);e.room.setActiveSketch(e,
g)}e.dispatch("initialised",this)},0);return this}Sketchpad.prototype=Object.create(Eventsmanager.prototype);
Object.assign(Sketchpad.prototype,{addSketchPage:function(a,b){function c(e){a.sid===e.getId()&&(d.removeListener("sketch-added",c),"function"===typeof b&&b(e,a))}var d=this;a=Object.assign({sid:"asp"+Math.random()+"h"+(a&&a.backgroundPdf&&a.backgroundPdf.fingerprint)},a);this.sendMessageToServer({cmd:"page",config:a},!1,function(){var e=d.room.addSketch(d,a,"no_autoselect");d.room.setActiveSketch(d,e)});this.on("sketch-added",c)},getToolsConfigs:function(){var a={},b,c=this;Object.keys(this.tools).forEach(function(d){b=
c.tools[d].getToolConfig();a[b.toolId]=b});return a},setToolsConfigs:function(a){var b=this;Object.keys(this.tools).forEach(function(c){var d=b.tools[c];c=a[c];d&&c&&d.setToolConfig(c)})},setMetaConfig:function(a,b){if(this.setMetaConfigFreeze)return!1;b&&(this.setMetaConfigFreeze=b);a=a||{};this.config=Object.assign(this.config,a);this.token=a.token||"#public";a.password&&(this.password=a.password||"");a.toolsConfigs&&this.setToolsConfigs(a.toolsConfigs);this.syncNetworkDataFrequency=a.syncNetworkDataFrequency||
1E3;this.centerViewport=!0;this.config.defaultTool&&this.getTool(this.config.defaultTool)&&this.setTool(this.config.defaultTool);this.displayGrid=this.config.features.displayGrid||!1;this.crosshairEl.style.display=this.config.features.displayCrosshair?"block":"none";this.hudsEl.style.display=this.config.features.displayViewports?"block":"none";this.dispatch("setMetaConfig",a,this.setMetaConfigFreeze);return this},setSketchConfig:function(a){a.viewportX=parseFloat(a.viewportX)||0;a.viewportY=parseFloat(a.viewportY)||
0;this.setViewportPosition(a.viewportX,a.viewportY);a.viewportScale=parseFloat(a.viewportScale)||1;this.setScale(a.viewportScale);a.viewportZRotation=parseFloat(a.viewportZRotation)||0;this.setRotation(a.viewportZRotation);var b=this;a.backgroundColor?(this.backgroundColor=a.backgroundColor,this.containerEl.style.backgroundColor=a.backgroundColor):(this.backgroundColor=!1,this.containerEl.style.backgroundColor="transparent");a.width||(a.width=1024);a.height||(a.height=768);a.backgroundUrl?(this.backgroundUrl=
a.backgroundUrl,this.backgroundIFrame.style.display="block",this.backgroundIFrame.width=a.width,this.backgroundIFrame.style.width=a.width+"px",this.backgroundIFrame.height=a.height,this.backgroundIFrame.style.height=a.height+"px",this.backgroundIFrame.src=a.backgroundUrl,this.backgroundIFrame.crossOrigin="anonymous"):(this.backgroundIFrame.src="about:blank",this.backgroundUrl=!1,this.backgroundIFrame.style.display="none");a.backgroundImage?(this.backgroundImage=a.backgroundImage,this.background.style.display=
"none",this.background.onload=function(){b.background.style.display="block";b.planRefreshWindow(0,"sketchpad.js:setSketchConfig:background.onload");b.backgroundImageProgressbar.uploadComplete()},this.background.onerror=function(){b.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar&&!this.backgroundImageProgressbar.completed&&this.backgroundImageProgressbar.cancel(),this.background.onerror=function(){b.backgroundImageProgressbar.cancel()},this.backgroundImageProgressbar=new Progressbar({progressParentEl:this.progressParentEl}),
this.backgroundImageProgressbar.startFakeProgress(),this.background.src=a.backgroundImage.toString(),this.background.crossOrigin="anonymous"):(this.background.src="",this.backgroundImage=!1,this.background.style.display="none");a.foregroundImage?(this.foregroundImage=a.foregroundImage,this.foreground.style.display="none",this.foreground.onload=function(){b.foreground.style.display="block";b.planRefreshWindow(0,"sketchpad.js:setSketchConfig:foreground.onload");b.foregroundImageProgressbar.uploadComplete()},
this.foreground.onerror=function(){b.foregroundImageProgressbar.cancel()},this.foregroundImageProgressbar&&!this.foregroundImageProgressbar.completed&&this.foregroundImageProgressbar.cancel(),this.foregroundImageProgressbar=new Progressbar({progressParentEl:this.progressParentEl}),this.foregroundImageProgressbar.startFakeProgress(),this.foreground.src=a.foregroundImage.toString(),this.foreground.crossOrigin="anonymous"):(this.foreground.src="",this.foregroundImage=!1,this.foreground.style.display=
"none");this.planRefreshWindow(0,"sketchpad.js:setSketchConfig");this.dispatch("setPageConfig",a);return this},getRoomConfig:function(){var a={};a.token=this.token;a.password=this.password;a.currentSketchSid=this.room.sketch&&this.room.sketch.getId()||"getRoomConfig-empty-sketch";a.toolsConfigs=this.getToolsConfigs();a.defaultTool=this.tool;a.toolbar=this.config.toolbar;a.features=this.config.features;return a},getSketchConfig:function(){var a={};a.viewportX=parseFloat(this.viewportX)||0;a.viewportY=
parseFloat(this.viewportY)||0;a.viewportScale=parseFloat(this.scale)||1;a.viewportZRotation=parseFloat(this.rotation)||0;this.config.backgroundType&&(a.backgroundType=this.config.backgroundType);this.config.backgroundColorR&&(a.backgroundColorR=this.config.backgroundColorR);this.config.backgroundColorG&&(a.backgroundColorG=this.config.backgroundColorG);this.config.backgroundColorB&&(a.backgroundColorB=this.config.backgroundColorB);this.config.backgroundColorR&&(a.backgroundColorA=this.config.backgroundColorA);
this.config.backgroundMapsLocation&&(a.backgroundMapsLocation=this.config.backgroundMapsLocation);this.config.backgroundPdf&&(a.backgroundPdf=this.config.backgroundPdf);this.config.backgroundMapsType&&(a.backgroundMapsType=this.config.backgroundMapsType);this.config.backgroundMapsZoom&&(a.backgroundMapsZoom=this.config.backgroundMapsZoom);this.backgroundColor&&(a.backgroundColor=this.backgroundColor);this.backgroundImage&&(a.backgroundImage=this.backgroundImage);this.backgroundUrl&&(a.backgroundUrl=
this.backgroundUrl);this.foregroundImage&&(a.foregroundImage=this.foregroundImage);return a},saveSketchpad:function(a){var b=[],c=this.getRoomConfig();a||(c.password="");b.push({hello:"Visit site www.sketchpad.pro to open this file.",site:"http://sketchpad.pro",description:"Sketchpad room file",cmd:"meta",config:c});for(a=0;a<this.room.sketches.length;a+=1)b.push(this.room.sketches[a].getPageConfig(this)),b=b.concat(this.room.sketches[a].getFrames());return b},colorPicker:function(a,b){var c=document.createElement("canvas");
c.width=1;c.height=1;var d=c.getContext("2d");this.backgroundColor&&(d.fillStyle=this.backgroundColor,d.fillRect(0,0,c.width,c.height));d.translate(-this.width/2-a,-this.height/2-b);this.background&&this.background.width&&(d.save(),d.translate(this.width/2,this.height/2),d.rotate(this.rotation*Math.PI/180),d.scale(this.scale,this.scale),d.translate(-this.viewportX,-this.viewportY),d.drawImage(this.background,-this.background.width/2,-this.background.height/2),d.restore());d.drawImage(this.canvasB,
0,0);d.drawImage(this.canvas,0,0);this.foreground&&this.foreground.width&&(d.save(),d.translate(this.width/2,this.height/2),d.rotate(this.rotation*Math.PI/180),d.scale(this.scale,this.scale),d.translate(-this.viewportX,-this.viewportY),d.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),d.restore());this.watermark&&d.drawImage(this.watermark,this.width-this.watermark.width,this.height-this.watermark.height);c=d.getImageData(0,0,1,1).data;return{r:c[0],g:c[1],b:c[2],a:c[3]/
255}},renderOutputCanvas:function(a){var b=document.createElement("canvas"),c=this.viewportX,d=this.viewportY,e=this.width,g=this.height,f=this.rotation,h=this.scale;b.width=e;b.height=g;var k=b.getContext("2d");!a||this.backgroundColor&&"transparent"!==this.backgroundColor||(this.backgroundColor=a);this.backgroundColor&&(k.fillStyle=this.backgroundColor,k.fillRect(0,0,b.width,b.height));this.backgroundCanvas&&k.drawImage(this.backgroundCanvas,0,0);this.background&&this.background.width&&(k.save(),
k.translate(e/2,g/2),k.rotate(f*Math.PI/180),k.scale(h,h),k.translate(-c,-d),k.drawImage(this.background,-this.background.width/2,-this.background.height/2),k.restore());k.drawImage(this.canvasB,0,0);k.drawImage(this.canvas,0,0);this.foreground&&this.foreground.width&&(k.save(),k.translate(e/2,g/2),k.rotate(f*Math.PI/180),k.scale(h,h),k.translate(-c,-d),k.drawImage(this.foreground,-this.foreground.width/2,-this.foreground.height/2),k.restore());this.watermark&&k.drawImage(this.watermark,e-this.watermark.width,
g-this.watermark.height);return b},screenshot:function(a,b,c){return this.renderOutputCanvas().toBlob(a,b,c)},toDataURL:function(a,b){var c=!1;"image/jpeg"===b&&(c="white");return this.renderOutputCanvas(c).toDataURL(a,b)},showGrid:function(a){function b(){function f(){for(var l=20;l<h;l+=40)for(var m=20;m<k;m+=30)e.fillStyle="#000000",e.fillRect(-l-1,-m-1,2,2),e.fillRect(-l-1,m-1,2,2),e.fillRect(l-1,m-1,2,2),e.fillRect(l-1,-m-1,2,2)}var h=Math.max(document.documentElement.clientWidth,window.innerWidth||
0),k=Math.max(document.documentElement.clientHeight,window.innerHeight||0);window.addEventListener("resize",function(){h=Math.max(document.documentElement.clientWidth,window.innerWidth||0);k=Math.max(document.documentElement.clientHeight,window.innerHeight||0);f()},!1);f();f()}function c(){function f(k,l){var m=-g.width/2,n=g.width/2;e.beginPath();e.strokeStyle=l;e.moveTo(m,k);e.lineTo(n,k);e.stroke()}console.log("that",g);var h;for(h=0;h<=g.height/1;h+=35)f(h,"rgba(0,0,0,0.2)");for(h=35;h<=g.height/
1;h+=35)f(-h,"rgba(0,0,0,0.2)")}function d(){function f(k,l){var m=-g.width/2;e.beginPath();e.moveTo(m,k);e.clearRect(m,k,canvas.width,canvas.height);e.stroke()}var h;for(h=0;h<=g.height/1;h+=35)f(h,"rgba(0,0,0,0.2)");for(h=35;h<=g.height/1;h+=35)f(-h,"rgba(0,0,0,0.2)")}console.log("show");"use strict";var e=this.contextProjector2D;if(!e)return!1;var g=this;this.displayGrid=!0;"Dot"===gridType.value?(console.log(gridType.value),d(),b()):"Line"===gridType.value?(d(),console.log(gridType.value),c()):
"Pure"===gridType.value&&d();e.restore()},hideGrid:function(){this.displayGrid=!1;this.contextProjector2D.clearRect(-this.width/2,-this.height/2,this.width,this.height)},clearProjector:function(){this.contextProjector2D.clearRect(-this.width/2,-this.height/2,this.width,this.height)},clearSketchpad:function(){this.windowWidth=this.containerEl.clientWidth;this.windowHeight=this.containerEl.clientHeight;this.backgroundCanvas.width=this.windowWidth;this.backgroundCanvas.height=this.windowHeight;this.canvas.width=
this.windowWidth;this.canvas.height=this.windowHeight;this.width=this.canvas.width;this.height=this.canvas.height;this.canvasB.width=this.windowWidth;this.canvasB.height=this.windowHeight;this.canvasProjector.width=this.windowWidth;this.canvasProjector.height=this.windowHeight;this.context2D=this.canvas.getContext("2d");this.contextB2D=this.canvasB.getContext("2d");this.contextProjector2D=this.canvasProjector.getContext("2d");this.context2D.lineCap="round";this.context2D.lineJoin="round";this.contextB2D.lineCap=
"round";this.contextProjector2D.lineJoin="round";this.contextProjector2D.lineCap="round";this.contextProjector2D.lineJoin="round";this.objectsCanva.innerHTML="";this.context2D.setTransform(1,0,0,1,0,0);this.contextB2D.clearRect(0,0,this.width,this.height);this.centerViewport&&(this.context2D.translate(this.width/2,this.height/2),this.contextB2D.translate(this.width/2,this.height/2),this.contextProjector2D.translate(this.width/2,this.height/2));this.displayGrid&&this.showGrid();if(this.backgroundIFrame)if(this.centerViewport){var a=
this.width/2-this.backgroundIFrame.width/2;var b=this.height/2-this.backgroundIFrame.height/2;var c=this.width/2;var d=this.height/2;this.backgroundIFrame.style.transformOrigin=c+"px "+d+"px";this.backgroundIFrame.style.webkitTransformOrigin=c+"px "+d+"px";this.backgroundIFrame.style.MozTransformOrigin=c+"px "+d+"px";this.backgroundIFrame.style.msTransformOrigin=c+"px "+d+"px";this.backgroundIFrame.style.OTransformOrigin=c+"px "+d+"px";this.backgroundIFrame.style.transform="scale("+1*this.scale+") rotate("+
1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)";this.backgroundIFrame.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)";this.backgroundIFrame.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)";this.backgroundIFrame.style.msTransform=
"scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)";this.backgroundIFrame.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)"}else this.backgroundIFrame.style.transform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.webkitTransform="translate("+
-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.MozTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.msTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.backgroundIFrame.style.OTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")";this.background&&(this.centerViewport?(a=this.width/2-this.background.width/
2,b=this.height/2-this.background.height/2,c=this.width/2,d=this.height/2,this.background.style.transformOrigin=c+"px "+d+"px",this.background.style.webkitTransformOrigin=c+"px "+d+"px",this.background.style.MozTransformOrigin=c+"px "+d+"px",this.background.style.msTransformOrigin=c+"px "+d+"px",this.background.style.OTransformOrigin=c+"px "+d+"px",this.background.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+
a+"px, "+b+"px)",this.background.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.background.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.background.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+
-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.background.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)"):(this.background.style.transform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.webkitTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.MozTransform=
"translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.msTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.background.style.OTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")"));this.foreground&&(this.centerViewport?(a=this.width/2-this.foreground.width/2,b=this.height/2-this.foreground.height/2,c=this.width/2,d=this.height/2,this.foreground.style.transformOrigin=
c+"px "+d+"px",this.foreground.style.webkitTransformOrigin=c+"px "+d+"px",this.foreground.style.MozTransformOrigin=c+"px "+d+"px",this.foreground.style.msTransformOrigin=c+"px "+d+"px",this.foreground.style.OTransformOrigin=c+"px "+d+"px",this.foreground.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.foreground.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+
"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.foreground.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.foreground.style.msTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)",this.foreground.style.OTransform="scale("+1*this.scale+
") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px) translate("+a+"px, "+b+"px)"):(this.foreground.style.transform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.webkitTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.MozTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.msTransform=
"translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")",this.foreground.style.OTransform="translate("+-this.viewportX+"px, "+-this.viewportY+"px) scale("+1*this.scale+")"));this.hudsEl.style.transformOrigin=this.width/2+"px "+this.height/2+"px";this.hudsEl.style.webkitTransformOrigin=this.width/2+"px "+this.height/2+"px";this.hudsEl.style.MozTransformOrigin=this.width/2+"px "+this.height/2+"px";this.hudsEl.style.msTransformOrigin=this.width/2+"px "+this.height/2+"px";this.hudsEl.style.OTransformOrigin=
this.width/2+"px "+this.height/2+"px";this.hudsEl.style.transform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)";this.hudsEl.style.webkitTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)";this.hudsEl.style.MozTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)";this.hudsEl.style.msTransform=
"scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)";this.hudsEl.style.OTransform="scale("+1*this.scale+") rotate("+1*this.rotation+"deg) translate("+-1*this.viewportX+"px, "+-1*this.viewportY+"px)"},refreshWindow:function(a){function b(f,h){if(d===c.postponeDrawingVersion&&e===c.room.sketch){var k;for(k=h;k<f.length&&k<h+g;k+=1)c.drawSketchFrame(f[k].evs,c.room.sketch);k<f.length?setTimeout(function(){b(f,k)},0):(Object.assign(c.canvas.style,
c.renderFadeEffectTransitionIn),Object.assign(c.canvasB.style,c.renderFadeEffectTransitionIn))}}Object.assign(this.canvas.style,this.renderFadeEffectTransitionOut);Object.assign(this.canvasB.style,this.renderFadeEffectTransitionOut);if(this.initialised&&!this.receivingHistory){this.sendInputs();this.drawInputs();var c=this;this.postponeDrawingVersion||(this.postponeDrawingVersion=0);this.postponeDrawingVersion+=1;9999<this.postponeDrawingVersion&&(this.postponeDrawingVersion=0);var d=this.postponeDrawingVersion,
e=this.room.sketch,g=this.postponeChunkLength;this.room&&this.room.sketch instanceof Sketch&&(1024<this.room.sketch.framesHistory.length?(this.loadingEl.style.display="flex",this.loadingEl.textContent="..."):this.loadingEl.style.display="none",a=c.room.sketch.getCommandsHist(),c.clearSketchpad(),c.loadingEl.style.display="none",b(a,0),c.dispatch("changeViewport"),c.dispatch("refreshWindow"))}},planRefreshWindow:function(a,b){a=parseInt(a)||0;this.planRefreshWindowTo&&clearTimeout(this.planRefreshWindowTo);
var c=this;this.planRefreshWindowTo=setTimeout(function(){c.refreshWindow(b)},a)},setViewportPosition:function(a,b,c){a=parseFloat(a);b=parseFloat(b);var d={deltaX:a-this.viewportX,deltaY:b-this.viewportY};this.viewportX=a;this.viewportY=b;var e=this;this.once("refreshWindow",function(){e.dispatch("setViewportPosition",d);c||e.sendCurrentViewport()},"setViewportPosition:sendCurrentViewport");this.planRefreshWindow(0,"sketchpad.js:setViewportPosition");return this},moveViewportRelative:function(a,
b){var c=-this.rotation,d={x:1/this.scale*a,y:1/this.scale*b};c=c/360*Math.PI*2;d={x:Math.cos(c)*d.x-Math.sin(c)*d.y,y:Math.sin(c)*d.x+Math.cos(c)*d.y};this.setViewportPosition(this.viewportX-d.x,this.viewportY-d.y);return this},setScale:function(a){(a=parseFloat(a))||(a=1);this.scale=a;this.setViewportPosition(this.viewportX,this.viewportY);return this},setRotation:function(a){a%=360;0>a&&(a+=360);this.rotation=a;this.setViewportPosition(this.viewportX,this.viewportY);this.dispatch("setRotation",
{o:a});return this},registerTool:function(a,b,c){"object"!==typeof c&&(c={});c.toolId=a;c.sketchpad=this;a=new b(c);this.tools[a.toolId]=a;var d=this;a.on("changeParams",function(){this===d.getCurrentTool()&&d.user&&d.user.user_id&&d.projectPointer(d.pointerX,d.pointerY)});this.config&&this.config.registerToolCb&&"function"===typeof this.config.registerToolCb&&this.config.registerToolCb(a)},getCurrentTool:function(){return this.getTool(this.tool)},getCurrentToolId:function(){return this.tool},getTool:function(a){return a?
this.tools[a]:this.getCurrentTool()},drawSketchNewFrames:function(){if(this.room.sketch instanceof Sketch&&this.room){var a,b=this.room.sketch.getCommandsCurrent();for(a=0;a<b.length;a+=1)this.drawSketchFrame(b[a].evs,this.room.sketch)}},reset:function(a){this.room.reset();a||(a={cmd:"reset",ts:(new Date).getTime()},this.sendMessageToServer(a));this.dispatch("reset");this.planRefreshWindow(0,"sketchpad.js:reset")},canDraw:function(){return!this.readOnly},clearCanvas:function(){this.inputs={};this.context2D.clearRect(0,
0,this.canvas.width,this.canvas.height);this.contextB2D.clearRect(0,0,this.canvas.width,this.canvas.height)},setTool:function(a,b){if(this.getTool(a)){var c=this.tool!==a,d=this.tool;this.tool=a;this.dispatch("setTool",{hasChanged:c,lastToolId:d,tool:this.getTool(a),extra:b});return this}},drawFramePath:function(a,b){if(this.drawingPaused)this.pausedQueue.push({config:a,points:b});else if(0<b.x.length){var c=this.getTool(a.tol);c?c.drawFramePath(a,b):console.warn("sketchpad.js","Unknown tool",a)}},
drawFrame:function(a){var b;for(b=0;b<a.length;b+=1)this.drawFramePath(a[b],a[b].pts)},pauseDrawing:function(){this.drawingPaused=!0},resumeDrawing:function(){var a;this.drawingPaused=!1;var b=this.pausedQueue;this.pausedQueue=[];for(a=0;a<b.length;a+=1)this.drawFramePath(b[a].config,b[a].points)},drawInputs:function(){var a=[],b,c,d,e=this;Object.keys(this.inputs).forEach(function(g){if(b=e.inputs[g])if(c=b.getPointsToDraw())d={},d.tol=b.tool,d.cnf=b.getConfig(),d.vpx=b.viewportX,d.vpy=b.viewportY,
d.scl=b.scale,d.rot=b.rotation,d.wdh=b.width,d.hgt=b.height,d.pts=c,d.uid=b.UID,a.push(d)});0<a.length&&this.drawFrame(a)},drawSketchFrame:function(a,b){var c,d;for(c=0;c<a.length;c+=1)void 0!==a[c].cid&&(d=b.getCachedFrame(a[c].cid)),this.drawFramePath(d,a[c].pts)},startPath:function(a,b,c,d){if(this.inputs[b])return!1;var e=this.getCurrentToolId();a=this.getTool(e).startInput(b,c,d,a);this.inputs[b]=a;this.dispatch("startPath",a)},drawPath:function(a,b,c,d){if(!this.inputs[b])return!1;this.getTool(this.inputs[b].tool).moveInput(this.inputs[b],
c,d,a)},endPath:function(a,b,c,d){if(!this.inputs[b])return!1;this.getTool(this.inputs[b].tool).finishInput(this.inputs[b],c,d,a);this.sendInputs();this.drawInputs();delete this.inputs[b]},syncCanvasFrame:function(){var a=this;if(this.windowWidth!==this.containerEl.clientWidth||this.windowHeight!==this.containerEl.clientHeight)this.windowWidth=this.containerEl.clientWidth,this.windowHeight=this.containerEl.clientHeight,this.once("refreshWindow",function(){a.sendCurrentViewport()},"syncCanvasFrame:sendCurrentViewport:(resize)"),
this.planRefreshWindow(0,"room.js:syncCanvasFrame:(resize)");this.receivingHistory&&(this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal);window.requestAnimationFrame(function(){a.syncCanvasFrame()});this.drawSketchNewFrames();this.drawInputs()},mainPos:function(a,b){var c=calculateOffsetXY(this.containerEl,a,b);this.centerViewport&&(c.x-=this.width/2,c.y-=this.height/2);return c},projectPointer:function(a,b){var c=this.getTool().getCursor(),d=this.pointerEl;
this.pointerEl.style.display="block";c&&c.pointer&&(this.containerEl.style.cursor=c.pointer);this.containerEl.style.cursor=c.pointer;Object.assign(d.style,c);d.style.position="absolute";d.style.left=a+"px";d.style.top=b+"px"},pointerMove:function(a,b){this.pointerX=parseInt(a+this.width/2,10);this.pointerY=parseInt(b+this.height/2,10);this.projectPointer(this.pointerX,this.pointerY)},createEventsDraw:function(){var a=this.containerEl,b=this;a.addEventListener("mousedown",function(c){if(b.inputEventsDisabled)return!1;
c.preventDefault();b.mouseLB=!0;var d=b.mainPos(c.clientX,c.clientY);b.startPath(c,0,d.x,d.y)},!1);a.addEventListener("mousemove",function(c){if(b.inputEventsDisabled)return!1;var d=b.mainPos(c.clientX,c.clientY);b.pointerMove(d.x,d.y);c.preventDefault();b.mouseLB&&b.drawPath(c,0,d.x,d.y)},!1);a.addEventListener("mouseup",function(c){if(b.inputEventsDisabled)return!1;c.preventDefault();b.mouseLB=!1;var d=b.mainPos(c.clientX,c.clientY);b.endPath(c,0,d.x,d.y)},!1);a.addEventListener("touchstart",function(c){if(b.inputEventsDisabled)return!1;
c.preventDefault();var d;for(d=0;d<c.changedTouches.length;d+=1){var e=b.mainPos(c.changedTouches[d].clientX,c.changedTouches[d].clientY);b.startPath(c,c.changedTouches[d].identifier+10,e.x,e.y)}},!1);a.addEventListener("touchmove",function(c){if(b.inputEventsDisabled)return!1;c.preventDefault();var d;for(d=0;d<c.changedTouches.length;d+=1){var e=b.mainPos(c.changedTouches[d].clientX,c.changedTouches[d].clientY);b.drawPath(c,c.changedTouches[d].identifier+10,e.x,e.y)}},!1);a.addEventListener("touchend",
function(c){if(b.inputEventsDisabled)return!1;c.preventDefault();var d;for(d=0;d<c.changedTouches.length;d+=1){var e=b.mainPos(c.changedTouches[d].clientX,c.changedTouches[d].clientY);b.endPath(c,c.changedTouches[d].identifier+10,e.x,e.y)}},!1)},disableInputEvents:function(){this.inputEventsDisabled=!0},enableInputEvents:function(){this.inputEventsDisabled=!1},getCurrentViewport:function(){return{sid:this.room.sketch&&this.room.sketch.getId()||"getCurrentViewport-init",x:this.viewportX,y:this.viewportY,
width:this.width,height:this.height,scale:this.scale,rotation:this.rotation,away:this.away}},sendCurrentViewport:function(){if(this.room.sketch instanceof Sketch){var a={cmd:"update-viewport",user:{user_id:this.user&&this.user.user_id||this.UID,color:this.COLOR,viewport:this.getCurrentViewport()}};this.sendMessageToServer(a);this.room.updateClient(a.user);this.dispatch("updateClient",a.user)}},undo:function(){this.room.sketch.undo(this)},redo:function(){this.room.sketch.redo(this)},sendStringToServer:function(a,
b,c){if(1===this.ws.readyState)try{this.ws.send(a),"function"===typeof b&&b()}catch(d){console.error("Error sending ws message",d,a),"function"===typeof c&&c(d)}else return"function"===typeof c&&c("offline"),"ignore"},sendMessageToServer:function(a,b,c){a=JSON.stringify(a);return this.sendStringToServer(a,b,c)},executeInputCommand:function(a){var b;switch(a.cmd){case "ping":this.sendMessageToServer({cmd:"pong",requestNo:a.no,requestTs:a.ts});break;case "goto":a.position&&(a.position.pageNo&&(b=this.room.getSketchByNo(a.position.pageNo))&&
this.room.setActiveSketch(this,b),void 0!==a.position.x&&void 0!==a.position.y&&this.setViewportPosition(a.position.x,a.position.y),a.position.scale&&this.setScale(a.position.scale),a.position.rotation&&this.setRotation(a.position.rotation));break;case "room-status":this.editorsCount=a.editorsCount;this.viewersCount=a.viewersCount;this.dispatch("changeRoomStatus");break;case "set-permissions":a.permissions?(this.readOnly=!a.permissions.canDraw,this.dispatch("set-permissions",a.permissions)):console.error("Received not valid permissions in set-permission response");
break;case "meta":a.config?this.setMetaConfig(a.config,"freeze"):console.error("Received not valid config in meta response");break;case "page":a.config?this.room.setPageConfig(this,a.config):console.error("Received not valid page config in page response");break;case "remove-page":a.sid&&(b=this.room.getSketchBySid(a.sid));b instanceof Sketch?this.room.removeSketch(this,b,"remoteRemove"):console.warn("cannot remove sketch by input sid","[",a.sid,"]");break;case "clear-page":a.sid&&(b=this.room.getSketchBySid(a.sid));
b instanceof Sketch?(b.reset(this,b,"remoteClear"),this.dispatch("sketch-cleared",b),this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:clear-page")):console.warn("cannot clear sketch by input sid","[",a.sid,"]");break;case "history-begin":this.receivingHistory=!0;this.loadingEl.style.display="flex";this.receivingHistoryInputsTotal=a.inputsCount||a.messagesCount||"?";this.receivingHistoryInputsLoaded=0;this.loadingEl.textContent=this.receivingHistoryInputsLoaded+"/"+this.receivingHistoryInputsTotal;
break;case "netspeed-begin":this.room.sketch.grindingThreshold=1E3;break;case "inputs":a.sid&&(b=this.room.getSketchBySid(a.sid));b instanceof Sketch||(console.warn("cannot find sketch by input sid, creating new sketch","[",a.sid,"]"),b=this.room.addSketch(this,Object.assign(this.getSketchConfig(),{sid:a.sid}),"remoteSketch"),this.room.sketch||this.room.setActiveSketch(this,b));this.receivingHistory&&(this.receivingHistoryInputsLoaded+=1);if(b!==this.room.sketch){var c=this.receivingHistory;this.receivingHistory=
!0}b.grindBulkFrame(this,a,this.receivingHistory);b!==this.room.sketch&&(this.receivingHistory=c);break;case "history-end":this.receivingHistory=!1;this.loadingEl.style.display="none";this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:history-end");break;case "netspeed-end":this.room.sketch.grindingThreshold=1E3/60;break;case "init-begin":this.initialised=!1;break;case "init-end":this.initialised=!0;this.config.currentPageNo||(this.config.currentPageNo=1);b=this.room.getSketchByNo(this.config.currentPageNo);
b||(this.config.currentPageNo=1,b=this.room.getSketchByNo(this.config.currentPageNo));b&&this.room.setActiveSketch(this,b);this.dispatch("initialised");break;case "reset":this.reset("remote");break;case "user-hello":a.user&&a.user.user_id&&a.user.viewport?(a.user.user_id=String(a.user.user_id),this.room.addClient(a.user),this.dispatch("addClient",a.user)):console.error("dropping user-hello, wrong  ``user || user.user_id``");break;case "pointer-move":a.user_id?this.room.setViewportPointer(a.user_id,
a.x,a.y):console.error("dropping pointer-move, wrong ``user_id``");break;case "update-viewport":a.user&&a.user.user_id&&a.user.viewport?(a.user.user_id=String(a.user.user_id),this.room.updateClient(a.user),this.dispatch("updateClient",a.user)):console.error("dropping user-viewport, wrong  ``user || user.user_id``");break;case "nick-changed":a.user_id&&a.user_name?(a.user_id=String(a.user_id),this.room.updateClient(a),this.dispatch("updateClient",a),this.user&&this.user.user_id&&String(this.user.user_id)===
a.user_id&&this.dispatch("my_nick_changed",a)):console.error("error nick-changed");break;case "color-changed":a.user_id&&a.user_color&&a.user_color_str?(a.user_id=String(a.user_id),this.room.updateClient(a),this.dispatch("updateClient",a),this.user&&this.user.user_id&&String(this.user.user_id)===a.user_id&&this.dispatch("my_color_changed",a)):console.error("error color-changed");break;case "user-bye":a.user&&a.user.user_id?(a.user.user_id=String(a.user.user_id),this.room.removeClientById(a.user.user_id),
this.dispatch("removeClient",a.user)):console.error("dropping user-bye, wrong  ``user || user.user_id``");break;case "undo":a&&a.uid&&a.sid&&(b=this.room.getSketchBySid(a.sid),b instanceof Sketch?b.undoSketch(this,a.uid):console.error("sketch not exists",a.sid,a),b===this.room.sketch&&this.planRefreshWindow(0,"sketchpad.js:executeInputCommand:undo"));break;case "you":a&&a.user&&((this.user=a.user)&&this.user.user_id&&(this.UID=a.user.user_id),this.dispatch("identify",a.user))}this.dispatch("customMessageFromServer",
a)},receiveMessageFromServer:function(a){var b=JSON.parse(a.data),c=this;b&&setTimeout(function(){c.executeInputCommand(b)},0)},sendInputs:function(){if(this.room&&this.room.sketch){var a={cmd:"inputs",sid:this.room.sketch.getId(),ts:(new Date).getTime(),uid:this.UID,evs:[]},b,c,d,e=this;Object.keys(this.inputs).forEach(function(g){(c=e.inputs[g])&&666!==g&&(d=c.getPointsToSend())&&(b={},b.tol=c.tool,b.cnf=c.getConfig(),b.vpx=c.viewportX,b.vpy=c.viewportY,b.scl=c.scale,b.rot=c.rotation,b.wdh=c.width,
b.hgt=c.height,b.pts=d,b.uid=c.UID,a.evs.push(b))});0<a.evs.length&&(this.sendMessageToServer(a),this.room.sketch.grindBulkFrame(this,a,!0))}},syncNetworkData:function(){this.syncNetworkDataTimeout&&clearTimeout(this.syncNetworkDataTimeout);this.syncNetworkDataTimeout=0;var a=this;this.syncNetworkDataTimeout=setTimeout(function(){a.syncNetworkData()},this.syncNetworkDataFrequency);this.sendInputs()}});